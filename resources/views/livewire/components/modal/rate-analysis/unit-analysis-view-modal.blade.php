<style>
    .error {
        color: red;
        font-size: small;
    }

    div#rowMessage {
        width: max-content;
    }

    select#selectOption {
        width: 10%;
        background: #1d2b74;
        color: white;
        text-align: center;
    }

    .active {
        margin-top: 0px;
    }

    div.dataTables_wrapper div.dataTables_paginate {
        display: none;
    }

    .col-sm-12.col-md-7 {
        display: none;
    }

    .col-sm-12.col-md-5 {
        display: none;
    }

    .actionbuttons {
        margin-top: 84px;
    }

    .prevdata {
        margin-bottom: 24px;
    }

    .col-md-3.pre {
        margin-right: 53px;
    }

    .col-md-6.cal-exp {
        margin-top: 21px;
        margin-left: 44px;
    }

    .button-cell {
        white-space: nowrap;
    }

    .addbtn {
        margin-left: 5px;
    }

    div.dataTables_wrapper div.dataTables_filter input {
        margin-left: 0.5em;
        display: inline-block;
        width: auto;
        border-radius: 50rem;
    }

    div.dataTables_wrapper div.dataTables_length select {
        width: auto;
        display: inline-block;
        border-radius: 50rem;
    }

    .card.input-fields {
        border-bottom-width: 1px;
    }

    .firstinput {
        background-color: #aaaaaa17;
    }

    .lastinput {
        background-color: #aaaaaa17;
    }

    button.btn.btn-primary.calc {
        width: auto;
        float: inline-end;
    }

    span.ovral-txt {
        margin-top: 2px;
    }

    .col-md-12.calculation-result {
        background: honeydew;
        width: 21%;
    }

    .col-md-12.calculation-result.p {
        font-style: italic;
        font-weight: 600;
    }

    .row.formulae {
        width: fit-content;
    }

    span.formula {
        FONT-WEIGHT: 800;
        margin-bottom: 23px;
        text-decoration-line: underline;
        color: #000000a8;
    }

    button.btn-close.delete-row-btn {
        background: #c03221;
        color: white;
        padding-top: 0px;
        padding-bottom: 8px;
    }

    button.btn-add.addbtn {
        background: darkgray;
        width: 22px;
        border-radius: 3px;
        color: white;
    }

    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    .modal-footer.rate-analysis {
        background: #f7f7f7;
        margin-top: 31px;
    }

    .modal-header.rate-analysis {
        background: #f7f7f7;
    }

    button.btn.rounded-pill.editBtn.delBtn {
        font-size: x-small;
    }

    .col-md-3.optionDropdown {
        flex: 0 0 auto;
        width: 16%;
    }

    .card.input-fields {

        width: 100%;
    }

    #more {
        display: none;
    }

    p.desp {
        margin-top: 0;
        margin-bottom: 0rem;
        color: black;
    }

    button#myBtn {
        color: blue;
        font-size: revert;
    }

    button.btn.btn-soft-primary.calc {
        float: inline-end;
    }

    /* new css 25-02-2024 */

    .table-unit.thead {
        white-space: nowrap;
        text-align: center;
    }

    .row.submitBtn {
        margin-top: 2%;
        margin-right: 35px;
    }

    #datatable1.table tbody tr td {
        vertical-align: middle;
    }

    input.form-control.m-input.empty-field:not(.total),
    select.form-control.m-input.empty-field {
        border-color: red;
    }

    a.selectOption {
        color: #212529ba;
        margin-left: 14PX;
    }

    a.prev-data {
        color: #212529ba;
        margin-left: 14PX;
    }

    .box-border {
        box-shadow: 1px 1px 3px;
        font: message-box;
    }

    .dropdown-menu li:hover {
        background-color: #3a57e8;
        color: #f7f7f7
    }

    .dropdown-menu li a {
        display: block;
        padding: 1px 10px;
        color: inherit;
        text-decoration: none;
    }

    ul.dropdown-menu.show {
        box-shadow: 0px 0px 5px;
    }

    button.btn.relative.rounded-md.shadow-sm.dropdown-toggle.box-border.show {
        background-color: #3a57e8;
        color: white;
    }

    #rulesDropdown {
        display: none;
        position: absolute;
        top: 0;
        left: 100%;
        margin-top: -1px;
        box-shadow: 0px 0px 5px;
    }

    .dropdown-item:hover {
        background-color: #3a57e8;
        color: white;
        box-shadow: 0px 0px 5px;
    }

    .table-container {
        position: relative;
    }

    table#dataTable {
        margin-top: 3%;
    }

    div#additionalFields {
        margin-top: 1%;
    }

    .grandTotalInput.box-border {
        background-color: #e9ecef;
        width: 20%;
    }

    .col-md-9.ttlll {
        text-align: end;
        margin-top: 8px;
        font-size: larger;
    }

    .row-table thead tr {
        background-color: #F5F6FA;
        text-align: center;
    }

    .unit {
        padding: 5px;
        padding-top: 1px;
        padding-bottom: 1px;
        width: auto;
        height: 42px;

    }

    div#rowMessage {
        width: max-content;
        background: none;
        border: none;
        padding: 0px;
    }

    .card.input-fields {
        height: 300px;
        /* Set the height of the card */
        overflow-y: auto;
        /* Enable vertical scrolling */
    }

    .card.input-fields .card-body {
        overflow-y: auto;
    }

    div#successAlert {
        width: max-content;
        background: none;
        border: none;
        padding: 0px;
        /* float: inline-end; */
    }

    button.btn.btn-soft-danger.btn-sm.delBtnn {
        margin-left: 73px;
    }

    .modal-dialog.modal-xl.modal-dialog-scrollable.unit-mdl {
        max-width: 1400px;
    }

    .highlight {
        border: 1px solid red;
    }

    .col-md-6.areaRadiocircle {
        width: auto;
    }

    button.btn.btn-soft-primary.add-btn-breadth {
        width: 100%;
    }

    button.btn.btn-soft-primary.add-btn-height {
        width: 100%;
    }

    button.btn.btn-soft-primary.add-btn-length {
        width: 100%;
    }
</style>

<div class="modal" id="myInput" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"
    data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable unit-mdl" role="document">
        <div class="modal-content rate-analysis">
            <?php
            $inputstring = ucfirst($sendArrayDesc);
            $pieces = explode(' ', $inputstring);
            $first_part = implode(' ', array_splice($pieces, 0, 5));
            $other_part = implode(' ', $pieces);
            ?>
            <div class="modal-header rate-analysis">
                <p class="desp">
                    <span id="dots">
                        <?php echo $first_part; ?> ...
                    </span>
                    <span id="more" style="display:none;">
                        <?php echo $first_part . ' ' . $other_part; ?>
                    </span>
                    <button id="myBtn">Read More</button>
                </p>
            </div>
            <div class="modal-body">
                <div>
                    <div class="prevdata row align-items-center">
                        <div class="col-md-3 optionDropdown">
                            <div class="dropdown">
                                <button class="btn relative rounded-md  dropdown-toggle box-border" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Select Option
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="selectOption" href="#" data-value="RULE">RULE</a></li>
                                    <div id="rulesDropdown" style="display: none;" class="dropdown-menu"
                                        aria-labelledby="dropdownMenuButton">
                                    </div>
                                    <li><a class="selectOption" href="#" data-value="OTHER">OTHER</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-3 pre">
                            @if ($arrayCount > 1)
                                @if (!empty($dropdownData))
                                    <div class="dropdown">
                                        <button class="btn relative rounded-md  dropdown-toggle box-border"
                                            id="mySelect" type="button" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            Select Previous Data
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" style="width:88%">
                                            <!-- Adjust the width as needed -->
                                            @isset($dropdownData)
                                                @foreach ($dropdownData as $listData)
                                                    <li><a class="prev-data" href="#">{{ $listData }}</a></li>
                                                @endforeach
                                            @endisset
                                        </ul>
                                    </div>
                                @endif
                            @endif
                        </div>
                        <div class="col-md-4 cal-exp">

                            <div class="input-group mb-3">
                                <input type="text" id="expression" class="form-control"
                                    placeholder="{{ trans('cruds.estimate.fields.operation') }}"
                                    aria-label="{{ trans('cruds.estimate.fields.operation') }}"
                                    aria-describedby="basic-addon1">
                                <input type="text" class="form-control" id="remarks"
                                    placeholder="{{ trans('cruds.estimate.fields.remarks') }}"
                                    aria-label="{{ trans('cruds.estimate.fields.remarks') }}"
                                    aria-describedby="basic-addon1">
                                <button type="button" id="calexp"
                                    class="btn btn-soft-primary operationcalculate">Calculate</button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group mb-3">
                                <button type="button" class="btn btn-soft-primary" id="totalOnSelected" disabled>
                                    {{ trans('cruds.estimate.fields.total_on_selected') }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div id="successAlert" class="alert" role="alert" style="display: none;"></div>
                    </div>
                    <div class="table-container" style="height: 200px; overflow-y: auto; margin-top: 3%;">
                        <table id="dataTable1" class="table mt-2 table-unit">
                            <thead>
                                <tr>
                                    <th class="whitespace-nowrap check" style="text-align:center;">
                                        <input type="checkbox" id="selectAllCheckbox"
                                            class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100
                                        border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400
                                        dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600
                                        dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600
                                        dark:focus:ring-offset-secondary-800" />
                                    </th>
                                    <th class="whitespace-nowrap" style="text-align:center;">Sl.no</th>
                                    <th class="whitespace-nowrap" style="text-align:center;">Option</th>
                                    <th class="whitespace-nowrap" style="text-align:center;">Total</th>
                                    <th class="whitespace-nowrap" style="text-align:center;">UNIT NAME</th>
                                    <th class="whitespace-nowrap" style="text-align:center;">Action</th>
                                    <th class="whitespace-nowrap" style="text-align:center;"></th>
                                </tr>
                            </thead>
                            <tbody class="metatable" id="metatable_id" style="overflow-y:auto;">
                                @if (isset($rateAnalysisArray[$unit_id]) && isset($rateAnalysisArray[$unit_id]['metadata']))
                                    <?php $lastTotalRow = null; ?>
                                    <?php foreach ($rateAnalysisArray[$unit_id]['metadata'] as $metadata): ?>
                                    <?php if (isset($metadata['key']) && $metadata['key'] === 'total'): ?>
                                    <?php $lastTotalRow = $metadata; ?>
                                    <?php endif; ?>
                                    <?php endforeach; ?>
                                    <?php foreach ($rateAnalysisArray[$unit_id]['metadata'] as $index => $metadata): ?>
                                    <tr>
                                        <td style="text-align:center;">
                                            <input type="checkbox"
                                                class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" />
                                        </td>
                                        <td style="text-align:center;">A<?php echo $index + 1; ?></td>
                                        <td style="text-align:center;">
                                            <?php echo $metadata['type']; ?>
                                            <?php if(isset($metadata['remarks']) && !empty($metadata['remarks'])): ?>
                                            [<?php echo $metadata['remarks']; ?>]
                                            <?php endif; ?>
                                        </td>
                                        <td style="text-align:center;"><?php echo $metadata['overallTotal']; ?></td>
                                        <td style="text-align:center;">
                                            {{ !empty($metadata['unit']) ? $metadata['unit'] : null }}</td>
                                        <td style="text-align:center;">
                                            @php
                                                $editButtonClass = null;
                                                if (isset($metadata['btntype'])) {
                                                    if ($metadata['btntype'] == 1) {
                                                        $editButtonClass = 'editBtnrule';
                                                    } elseif ($metadata['btntype'] == 2) {
                                                        $editButtonClass = 'editBtn';
                                                    } elseif ($metadata['btntype'] == 3) {
                                                        $editButtonClass = 'defaultbtn';
                                                    } elseif ($metadata['btntype'] == 4) {
                                                        $editButtonClass = 'sabtn';
                                                    } elseif ($metadata['btntype'] == 5) {
                                                        $editButtonClass = 'apcbtn';
                                                    } elseif ($metadata['btntype'] === 6) {
                                                        $editButtonClass = 'vcbtn';
                                                    }
                                                }
                                            @endphp
                                            @if (!isset($metadata['key']))
                                                @if (isset($metadata['currentId']))
                                                    <a type="button"
                                                        class="btn btn-soft-secondary btn-sm mr-2 {{ $editButtonClass }} fetchdetails"
                                                        data-id="{{ $metadata['currentId'] }}">Edit</a>
                                                @endif

                                            @endif
                                            <?php if ($metadata === $lastTotalRow): ?>
                                            <a type="button" class="btn btn-soft-danger btn-sm delBtn"
                                                data-id="{{ $metadata['currentId'] }}">Delete</a>
                                            <?php endif; ?>
                                        </td>
                                        <td><input type="hidden" id="metagrandval"
                                                value="{{ isset($metadata['grandTotal']) ? $metadata['grandTotal'] : '0' }}">
                                        </td>
                                    </tr>
                                    <?php endforeach; ?>
                                @endif
                            </tbody>
                        </table>
                    </div>
                    <div class="row" id="metagrandtotal" style="overflow-y: auto;margin-top: 26px;">
                        <div class="col-md-9 ttlll">
                            Grand Total:
                        </div>
                        <div class="col-md-3  grandTotalInput" style="width:20%;">
                            <input type="text" id="grandTotalInput" class="form-control" value="0" readonly>
                        </div>
                    </div>



                    <form id="myForm" style="display:none;">
                        <div class="alert alert-danger" role="alert" id="emptyFieldsAlert" style="display: none;">
                            Please fill in all fields before submitting.
                        </div>
                        <div class="">
                            <div class="col-lg-12">
                                <div class="table-container">
                                    <table id="dataTable" class="table row-table">
                                        <thead>
                                            <tr class="thead">
                                                <th>Sl.no</th>
                                                <th>Member</th>
                                                <th>Number</th>
                                                <th>Length</th>
                                                <th>Breadth</th>
                                                <th>Height</th>
                                                <th>Unit</th>
                                                <th>Total</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="newinput">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 16px;">
                            <div class="col-md-9 ttlll">
                                Rows Total:
                            </div>
                            <div class="col-md-3 grandTotalInput">
                                <input type="text" id="totalSum" class="form-control m-input" value="0.00"
                                    readonly>
                            </div>
                        </div>
                        <div class="row submitBtn">
                            <div class="col">
                                <button id="submitBtn" type="button" class="btn btn-soft-primary"
                                    style="float:right;">Save</button>
                            </div>
                        </div>
                    </form>

                    <div id="additionalFields" style="display: none;">
                        <div class="card input-fields overflow-auto">
                            <div class="card-body overflow-auto" style="background-color: #f4f8fb;">
                                <div id="simpson" class="row formulae">
                                    <span class="formula"></span>
                                </div>
                                <div id="rowMessage" class="alert alert-info" style="display: none;"></div>
                                <form id="simpsonsRuleForm" class="row g-3 align-items-center">
                                    <div class="col-md-6">
                                        <label for="floatingInput">Enter Number of 'Y' Input </label>
                                        <input type="number" class="form-control" id="Input_for_Y_def"
                                            placeholder="Enter number of 'Y'" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="floatingInput">Enter value of 'W' Input</label>
                                        <input type="number" class="form-control" id="Input_for_W"
                                            placeholder="Enter number of 'W'" required>
                                    </div>
                                    <div class="col-md-12">
                                        <div id="error_message" class="text-danger"></div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div id="Area-perimeter-rectangle" style="display: none; margin-top: 1%;">
                        <div class="card input-fields overflow-auto">
                            <div class="card-body overflow-auto" style="background-color: #f4f8fb;">
                                <div id="simpson" class="row formulae">
                                    <span class="formula"></span>
                                </div>
                                <div id="rowMessage" class="alert alert-info" style="display: none;"></div>
                                <form id="area-perimeter-rectangle" class="row g-3 align-items-center">
                                    <div class="col-md-6">
                                        <label for="length">Enter Length </label>
                                        <input type="number" class="form-control" id="length"
                                            placeholder="Enter Length" required>
                                        <input type="hidden" class="form-control" id="btntype">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="width">Enter Width </label>
                                        <input type="number" class="form-control" id="width"
                                            placeholder="Enter Width" required>
                                    </div>
                                    <div class="col-md-12">
                                        <div id="error_message" class="text-danger"></div>
                                    </div>
                                </form>
                                <div id="result-circle" class="row mt-3" style="width: 19%;">
                                    <div class="col-md-6">
                                        <input type="radio" id="areaRadio" class="form-check-input"
                                            name="calcOption" value="area" checked>
                                        <label class="form-check-label" for="areaRadio">Area</label>
                                        <span id="areaValue"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="radio" id="perimeterRadio" class="form-check-input"
                                            name="calcOption" value="perimeter">
                                        <label class="form-check-label" for="perimeterRadio">Perimeter</label>
                                        <span id="perimeterValue"></span>
                                    </div>
                                </div>
                                <button id="saveBtn" type="button" class="btn btn-soft-primary"
                                    style="float: inline-end;">Save</button>
                            </div>
                        </div>
                    </div>
                    <div id="surfaceArea-volume-rectangle" style="display: none; margin-top: 1%;">
                        <div class="card input-fields overflow-auto">
                            <div class="card-body overflow-auto" style="background-color: #f4f8fb;">
                                <div id="simpson" class="row formulae">
                                    <span class="formula"></span>
                                </div>
                                <div id="rowMessage" class="alert alert-info" style="display: none;"></div>
                                <form id="surfaceArea-volume-rectangle" class="row g-3 align-items-center">
                                    <input type="hidden" class="form-control btn-type" id="btn-type2">
                                    <div class="col-md-6">
                                        <label for="length">Enter Length</label>
                                        <input type="number" class="form-control salength" name="salength"
                                            id="salength" placeholder="Enter Length" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="width">Enter Width</label>
                                        <input type="number" class="form-control sawidth" name="sawidth"
                                            id="sawidth" placeholder="Enter Width" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="height">Enter Height</label>
                                        <input type="number" class="form-control saheight" name="saheight"
                                            id="saheight" placeholder="Enter Height" required>
                                    </div>
                                    <div class="col-md-12">
                                        <div id="error_message" class="text-danger"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col text-end">
                                            <button id="saveBtn1" type="submit" class="btn btn-soft-primary"
                                                style="width:auto">Save</button>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                    <div id="Volume-of-cylinder" style="display: none; margin-top: 1%;">
                        <div class="card input-fields overflow-auto">
                            <div class="card-body overflow-auto" style="background-color: #f4f8fb;">
                                <div id="simpson" class="row formulae">
                                    <span class="formula"></span>
                                </div>
                                <div id="rowMessage" class="alert alert-info" style="display: none;"></div>
                                <form id="Volume-of-cylinder" class="row g-3 align-items-center">
                                    <input type="hidden" class="form-control btn-type" id="btn-type2">
                                    <div class="col-md-6">
                                        <label for="length">Enter Diameter
                                        </label>
                                        <input type="number" class="form-control diameter" name="diameter"
                                            id="diameter" placeholder="Enter value" required>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="height">Enter Height</label>
                                        <input type="number" class="form-control dia-height" name="dia-height"
                                            id="dia-height" placeholder="Enter value" required>
                                    </div>
                                    <div class="col-md-12">
                                        <div id="error_message" class="text-danger"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col text-end">
                                            <button id="saveBtn2" type="submit" class="btn btn-soft-primary"
                                                style="width:auto">Save</button>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                    <div id="Area-perimeter-circle" style="display:none; margin-top: 1%;">
                        <div class="card input-fields overflow-auto">
                            <div class="card-body overflow-auto" style="background-color: #f4f8fb;">
                                <div id="simpson" class="row formulae">
                                    <span class="formula"></span>
                                </div>
                                <div id="rowMessage" class="alert alert-info" style="display: none;"></div>
                                <div class="col-md-3">
                                    <div class="dropdown">
                                        <button
                                            class="btn relative rounded-md  dropdown-toggle box-border circle-dropdown"
                                            type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            Select Shape
                                        </button>
                                        <div id="dropdownMessage" class="text-danger" style="display:none;">Select
                                            circle type first</div>
                                        <ul class="dropdown-menu">
                                            <li><a class="selectOptionn" href="#" data-value="circle">Full
                                                    Circle</a></li>
                                            <li><a class="selectOptionn" href="#" data-value="semiCircle">Semi
                                                    Circle</a></li>
                                            <li><a class="selectOptionn" href="#"
                                                    data-value="quarterCircle">Quarter Circle</a></li>
                                            <li><a class="selectOptionn" href="#"
                                                    data-value="Surface Area of Sphere">Surface Area of Sphere</a></li>
                                            <li><a class="selectOptionn" href="#"
                                                    data-value="Volume of Sphere">Volume of Sphere</a></li>
                                            <li><a class="selectOptionn" href="#"
                                                    data-value="Surface Area of Hemisphere">Surface Area of
                                                    Hemisphere</a></li>
                                            <li><a class="selectOptionn" href="#"
                                                    data-value="Volume of Hemisphere">Volume of Hemisphere</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <form id="area-perimeter-circle" class="row g-3 align-items-center"
                                    style="margin-top:2px;">
                                    <div class="col-md-6">
                                        <label for="radius">Enter radius </label>
                                        <input type="number" class="form-control" id="radius"
                                            placeholder="Enter radius" required style="width:26%;">
                                        <input type="hidden" class="form-control" id="btntype">
                                    </div>
                                    <div id="radiusMessage" class="text-danger" style="display:none;margin-top: 0;">
                                        Required field</div>
                                </form>
                                <div id="result-circle" class="row mt-3">
                                    <div class="col-md-6 areaRadiocircle">
                                        <input type="radio" id="areaRadiocircle" class="form-check-input"
                                            name="calcOptionn" value="area" checked>
                                        <label class="form-check-label" for="areaRadio">Area</label>
                                        <span id="areaValue"></span>
                                    </div>
                                    <div class="col-md-6 perimeterRadiocircle">
                                        <input type="radio" id="perimeterRadiocircle" class="form-check-input"
                                            name="calcOptionn" value="perimeter">
                                        <label class="form-check-label" for="perimeterRadio">Perimeter</label>
                                        <span id="perimeterValue"></span>
                                    </div>
                                </div>
                                <button id="saveBtnn" type="submit" class="btn btn-soft-primary"
                                    style="float: inline-end;">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer rate-analysis" style="display: flex; justify-content: space-between;">
                <button type="button" id="close-unit-modalBtn" class="btn btn-soft-danger rounded-pill "
                    data-dismiss="modal">Close</button>
                <button id="finalSubmitBtn" type="button" class="btn btn-success rounded-pill "
                    disabled>Submit</button>
            </div>
        </div>
    </div>
</div>
<script>
    window.scrollTo(0, 1000);
    var currentId = null;
    var area = 0;
    var perimeter = 0;
    var type = '';
    var dataValue = null;
    var selectedOption = '';
    $(document).ready(function() {
        var unitId = @json($unit_id);
        var editEstimate_Id = @json($editEstimate_id);
        var arrayCount = @json($arrayCount);
        var myModal = new bootstrap.Modal(document.getElementById('myInput'), {
            backdrop: 'static'
        });
        myModal.show();
        $(document).off("click", "#close-unit-modalBtn");
        $(document).on("click", "#close-unit-modalBtn", function() {
            if ($(this).html() === "Close") {
                $("#myInput").modal('hide');
             } else {
                closeModal();
            }
        });

        function closeModal() {
            var grandTotal = 0;
            grandTotal = $('#grandTotalInput').val();
            if (confirm("Are you sure you want to close and reset?")) {
                window.Livewire.emit('closeAndReset', grandTotal, unitId);
            } else {
                return;
            }
            $("#myInput").modal('hide');
            window.Livewire.emit('closeUnitModal');
        }

        $('#finalSubmitBtn').click(function() {
            var grandTotal = 0;
            // $('.metatable td:nth-child(3)').each(function() {
            //     grandTotal += parseFloat($(this).text());
            // });
            grandTotal = $('#grandTotalInput').val();
            window.Livewire.emit('submitGrandTotal', grandTotal, unitId);
            $("#myInput").modal('hide');
        });
        // $('#grandTotalInput').on('keyup click keydown keypress keyup mouseenter mouseleave', function() {
        //     if (!$(this).prop('disabled')) {
        //         $(this).prop('disabled', true);
        //     }
        // });

        function updateGrandTotal() {
            var grandTotal = 0;
            $('#dataTable1 tbody tr').each(function() {
                var grandTotal = parseFloat($(this).find('#metagrandval').val());
                var roundedGrandTotal = grandTotal.toFixed(2);
                $('#grandTotalInput').val(roundedGrandTotal);
            });
            if (parseFloat(grandTotal) !== 0) {
                //alert(grandTotal);
                $("#calexp").prop("disabled", true);
                $("#totalOnSelected").prop("disabled", true);
                $('.optionDropdown button.dropdown-toggle').prop('disabled', true);

            }
            var tableHeight = $('#dataTable1').height();
            var tableOffsetTop = $('#dataTable1').offset().top;
            var grandTotalInputHeight = $('.grandTotalInput').height();
            var newPositionTop = tableHeight + tableOffsetTop + 20;
            $('.grandTotalInput').css('top', newPositionTop + 'px');
        }
        $('.metatable').on('DOMSubtreeModified', function() {
            $("#metatable_id input[type=checkbox]").change(function() {
                if (!$(this).is(":checked")) {
                    $("#selectAllCheckbox").prop("checked", false);
                    $("#totalOnSelected").prop("disabled", false);
                }
            });
            updateGrandTotal();
        });
        updateGrandTotal();
        $("#metatable_id input[type=checkbox]").change(function() {
            if (!$(this).is(":checked")) {
                $("#selectAllCheckbox").prop("checked", false);
            }
        });
        var rules = ["Simpson-rule", "Area and Perimeter of rectangle", "Surface Area & volume of rectangle",
            "Area and Perimeter of circle", "Volume of Cylinder",
        ];
        var ruleDataValues = {
            "Simpson-rule": "1",
            "Area and Perimeter of rectangle": "3",
            "Surface Area & volume of rectangle": "4",
            "Area and Perimeter of circle": "5",
            "Volume of Cylinder": "6"
        };

        function populateRulesDropdown() {
            var dropdownContent = "";
            rules.forEach(function(rule) {
                dropdownContent +=
                    `<a class="dropdown-item rule-item" data-value="${ruleDataValues[rule]}" href="#">${rule}</a>`;
            });
            $('#rulesDropdown').html(dropdownContent);
        }
        $('.dropdown-menu').on('mouseover', '.selectOption[data-value="RULE"]', function() {
            var grandTotalValue = $('#grandTotalInput').val();
            $('.rowCheckbox').prop('checked', false);
            if (parseFloat(grandTotalValue) === 0) {
                $('#rulesDropdown').show();
                populateRulesDropdown();
            } else {
                if (!this.acceptanceCriteria()) {
                    return;
                }
            }
        });
        $('.dropdown-menu').on('click', '.selectOption[data-value="RULE"]', function() {
            var grandTotalValue = $('#grandTotalInput').val();
            $('.rowCheckbox').prop('checked', false);
            if (parseFloat(grandTotalValue) === 0) {
                var form = document.getElementById("simpsonsRuleForm");
                form.reset();
                currentId = null;
                type = "";
                $('#rulesDropdown').show();
                populateRulesDropdown();
            } else {
                alert("Total Aready done!");
                if (!this.acceptenceCriteria()) {
                    return;
                }
            }
        });
        $('.dropdown-menu').on('mouseover', '.selectOption[data-value="OTHER"]', function() {
            $('#rulesDropdown').hide();
        });
        $('.dropdown-menu').on('click', '.selectOption[data-value="OTHER"]', function() {
            var grandTotalValue = $('#grandTotalInput').val();
            $('.rowCheckbox').prop('checked', false);
            if (parseFloat(grandTotalValue) === 0) {
                $('#rulesDropdown').hide();
                currentId = null;
                type = "";
                var tableBody = $("#dataTable tbody");
                tableBody.empty();
                addNewRow();
                updateTotalSum();
            } else {
                alert("Total Aready done!");
                if (!this.acceptenceCriteria()) {
                    return;
                }
            }
        });
        $('.selectOption').click(function() {
            var selectedOption = $(this).data('value');
            $('#selectOptionButton').addClass('btn-clicked');
            if (selectedOption === "RULE") {
                return;
            } else if (selectedOption === "OTHER") {
                $('#additionalFields').hide();
                var grandTotalValue = $('#grandTotalInput').val();
                $('.rowCheckbox').prop('checked', false);
                if (parseFloat(grandTotalValue) === 0) {
                    $('#myForm').show();
                    $('#Area-perimeter-circle').hide();
                    $('#surfaceArea-volume-rectangle').hide();
                    $('#Area-perimeter-rectangle').hide();
                    $('#additionalFields').hide();
                } else {
                    alert("Total Aready done!");
                    if (!this.acceptenceCriteria()) {
                        return;
                    }
                }
            }
        });
        $('.dropdown').on('mouseleave', function() {
            $('#rulesDropdown').hide();
        });
        $('#rulesDropdown').on('click', '.rule-item', function() {
            type = $(this).text().trim();
            dataValue = $(this).data('value');
            if (dataValue === 1) {
                $('.formula').html(`Formula : Simpson rule:-Area=(w/3)[yfirst + 4(yodd) +
                                        2(yeven) +
                                        ylast]`);
                $('#additionalFields').show();
                $('#myForm').hide();
                $('#Area-perimeter-rectangle').hide();
                $('#Area-perimeter-circle').hide();
                $('#surfaceArea-volume-rectangle').hide();
                var form = document.getElementById("simpsonsRuleForm");
                form.reset();
                currentId = null;
                // type = "";
            } else if (dataValue === 3) {
                $('.formula').html(`Formula : Area = length x width / Perimeter = 2 (length +
                                        width)`);

                $('#Area-perimeter-rectangle').show();
                $('#Area-perimeter-circle').hide();
                $('#surfaceArea-volume-rectangle').hide();
                $('#additionalFields').hide();
                $('#myForm').hide();
                var form = document.getElementById("area-perimeter-rectangle");
                form.reset();
                currentId = null;
            } else if (dataValue === 4) {
                $('.formula').html(`Formula : Surface Area = 2(wl+hl+hw)`);
                $('#surfaceArea-volume-rectangle').show();
                $('#Area-perimeter-circle').hide();
                $('#Area-perimeter-rectangle').hide();
                $('#additionalFields').hide();
                $('#myForm').hide();
                $('#surfaceArea-volume-rectangle').trigger('reset');
                currentId = null;
            } else if (dataValue === 5) {
                $('.formula').html(`Formula : Area of Circle = πR2 / Perimeter of Circle = 2πR (π
                                        ≈ 3.14)`);
                $('#Area-perimeter-circle').trigger('reset');
                $('#Area-perimeter-circle').show();
                $('#surfaceArea-volume-rectangle').hide();
                $('#Area-perimeter-rectangle').hide();
                $('#additionalFields').hide();
                $('#myForm').hide();
                $('#surfaceArea-volume-rectangle').trigger('reset');
                currentId = null;
            } else if (dataValue === 6) {
                $('.formula').html(`Formula : Volume of Cylinder = πd2 * h / 4 (π
                                        ≈ 3.14)`);
                $('#Volume-of-cylinder').show();
                $('#Volume-of-cylinder').trigger('reset');
                $('#Area-perimeter-circle').hide();
                $('#surfaceArea-volume-rectangle').hide();
                $('#Area-perimeter-rectangle').hide();
                $('#additionalFields').hide();
                $('#myForm').hide();
                $('#surfaceArea-volume-rectangle').trigger('reset');
            } else {
                $('#Volume-of-cylinder').hide();
                $('#Area-perimeter-circle').hide();
                $('#additionalFields').hide();
                $('#Area-perimeter-rectangle').hide();
                $('#surfaceArea-volume-rectangle').hide();
                alert("OOPS! Nothing Found for " + type);
                currentId = null;
                return;
            }
        });

        function calculateAreaPerimeter() {
            var length = parseFloat($('#length').val());
            var width = parseFloat($('#width').val());
            if (!isNaN(length) && !isNaN(width) && length > 0 && width > 0) {
                area = length * width;
                perimeter = 2 * (length + width);
                $('#areaValue').text(area.toFixed(2));
                $('#perimeterValue').text(perimeter.toFixed(2));
            } else {
                $('#areaValue').text('');
                $('#perimeterValue').text('');
            }
        }
        $('#length, #width').on('input', calculateAreaPerimeter);
        $('#saveBtn').on('click', function() {
            var length = parseFloat($('#length').val());
            var width = parseFloat($('#width').val());
            var dataValue = parseFloat($('#btntype').val());
            selectedOption = $('input[name="calcOption"]:checked').val();
            if (isNaN(length) || isNaN(width) || length <= 0 || width <= 0) {
                alert('Please enter valid values for length and width.');
                return;
            }
            if (selectedOption === 'area') {
                area = length * width;
                var totalOverallTotal = area.toFixed(2);
            } else if (selectedOption === 'perimeter') {
                perimeter = 2 * (length + width);
                var totalOverallTotal = perimeter.toFixed(2);
            }

            var inputValues = {};
            inputValues["parent_id"] = unitId;
            inputValues["currentId"] = currentId;
            if (!type) {
                type = 'Area and perimeter of rectangle';
            }
            inputValues["type"] = type + '(' + selectedOption + ')';
            inputValues["btntype"] = 3;
            inputValues["unit"] = "Cum";
            inputValues["overallTotal"] = totalOverallTotal !== '' ? totalOverallTotal :
                0;
            inputValues["length"] = length;
            inputValues["width"] = width;
            inputValues["editEstimate_id"] = editEstimate_Id;
            var ruledata = {
                input_values: inputValues
            };
            console.log(ruledata);
            $.ajax({
                url: '/calculate-rule-area-perimeter',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    data: ruledata
                }),
                success: function(response) {
                    console.log("1");

                    var tableBody1 = $("#dataTable tbody");
                    tableBody1.empty();
                    var rateAnalysisArray1 = response.rateAnalysisArray[
                        unitId][
                        'metadata'
                    ];
                    if ($.isEmptyObject(rateAnalysisArray1)) {
                        $("#close-unit-modalBtn").html("Close");
                    }
                    var tableBody = $("#dataTable1 tbody");
                    tableBody.empty();
                    var sno = 0;
                    $.each(rateAnalysisArray1, function(index, metadata) {
                        var newRow = $("<tr>");
                        newRow.append(
                            '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                        );
                        newRow.append(
                            '<td style="text-align:center;">A' +
                            (
                                sno +
                                1) +
                            '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata.type + (metadata.remarks ?
                                ' (' +
                                metadata.remarks + ')' : '') +
                            '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata
                            .overallTotal + '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata
                            .unit +
                            '</td>');
                        var editButtonClass = '';
                        if (metadata.btntype === 1) {
                            editButtonClass = 'editBtnrule';
                        } else if (metadata.btntype === 2) {
                            editButtonClass = 'editBtn';
                        } else if (metadata.btntype === 3) {
                            editButtonClass = 'defaultbtn';
                        } else if (metadata.btntype === 4) {
                            editButtonClass = 'sabtn';
                        } else if (metadata.btntype === 5) {
                            editButtonClass = 'apcbtn';
                        } else if (metadata.btntype === 6) {
                            editButtonClass = 'vcbtn';
                        }
                        var editButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                editButtonClass,
                            'data-id': metadata.currentId
                        }).text('edit');
                        var deleteButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-danger btn-sm delBtn',
                            'data-id': metadata.currentId
                        }).text('Delete');
                        var grandTotalValue = metadata.grandTotal;
                        var hiddenInput = $('<input>').attr({
                            'type': 'hidden',
                            'id': 'metagrandval',
                            'value': grandTotalValue
                        });
                        var buttonCell = $('<td>').css('text-align', 'center')
                            .append(editButton).append(' ').append(deleteButton);
                        if (metadata.hasOwnProperty('key')) {
                            editButton.remove();
                            tableBody.find('.delBtn').remove();
                            buttonCell.append(deleteButton);
                        }
                        if (metadata.hasOwnProperty('expcalculate')) {
                            $("#finalSubmitBtn").prop("disabled", false);
                            $("#close-unit-modalBtn").html("Reset & close");
                        } else {
                            $("#finalSubmitBtn").prop("disabled", true);
                            $("#close-unit-modalBtn").html("Reset & close");
                        }
                        newRow.append(hiddenInput).append(buttonCell);
                        tableBody.append(newRow);
                        sno++;
                        $('#grandTotalInput').val(metadata.grandTotal !==
                            undefined &&
                            metadata.grandTotal !== null ? metadata.grandTotal :
                            0);
                    });
                    addNewRow();
                    updateTotalSum();
                    if (tableBody.find('tr').length > 0) {
                        $('#mySelect').hide();
                        $('#metagrandtotal').show();
                    } else {
                        $('#mySelect').show();
                        $('#metagrandtotal').hide();
                    }
                    $('#successAlert').text('Row Total added successfully');
                    $('#successAlert').addClass('alert-success')
                        .removeClass(
                            'alert-danger')
                        .show();
                    //$("#finalSubmitBtn").prop("disabled", false);
                    setTimeout(function() {
                        $('#successAlert').hide();
                    }, 2000);
                    $('#metagrandtotal').show();

                    // $("#finalSubmitBtn").prop("disabled", false);
                    $('.rowCheckbox').prop('checked', false);
                    $('#Area-perimeter-rectangle').hide();
                    $('#Area-perimeter-circle').hide();
                    $('#surfaceArea-volume-rectangle').hide();
                    $('#additionalFields').hide();
                    $('#myForm').hide();
                    var form = document.getElementById("area-perimeter-rectangle");
                    form.reset();
                    currentId = null;
                    $('#myForm').hide();
                    var form = document.getElementById(
                        "area-perimeter-rectangle");
                    form.reset();
                    currentId = null;
                    $('#areaValue').text('');
                    $('#perimeterValue').text('');
                    $("#calexp").prop("disabled", false);
                    $('.optionDropdown button.dropdown-toggle').prop('disabled', false);
                },
                error: function(xhr, status, error) {
                    var errorMessage =
                        "An error occurred while calculating: ";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += xhr.responseJSON.error;
                    } else {
                        errorMessage += xhr.statusText;
                    }
                    alert(errorMessage);
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        $('#myBtn').click(function() {
            var dots = document.getElementById("dots");
            var moreText = document.getElementById("more");
            var btnText = document.getElementById("myBtn");
            if (dots.style.display === "none") {
                dots.style.display = "inline";
                btnText.innerHTML = "Read More";
                moreText.style.display = "none";
            } else {
                dots.style.display = "none";
                btnText.innerHTML = "... Read Less";
                moreText.style.display = "inline";
            }
        });
        var numberOfY = 0;
        var firstInputResult, lastInputResult, oddSumResult, evenSumResult, areaResult;
        document.getElementById("Input_for_Y_def").addEventListener("input", function() {
            handleInputChanges();
            resetResults();
        });

        function handleInputChanges() {
            var numberOfY = parseInt(document.getElementById("Input_for_Y_def").value);
            var form = document.getElementById("simpsonsRuleForm");
            var errorMessage = document.getElementById("error_message");
            errorMessage.textContent = "";
            var existingYInputs = form.querySelectorAll("input[name^='Input_for_Y']");
            for (var i = 0; i < existingYInputs.length; i++) {
                existingYInputs[i].parentNode.remove();
            }
            var calculateButton = form.querySelector(".calc");
            if (calculateButton) {
                calculateButton.parentNode.remove();
            }
            if (numberOfY % 2 !== 0) {
                errorMessage.textContent = "Please enter even numbers for 'Y'";
                return;
            }
            var inputForW = document.getElementById("Input_for_W").parentNode;
            for (var i = numberOfY; i >= 1; i--) {
                var label = document.createElement("label");
                label.textContent = "Input for Y" + i;
                var input = document.createElement("input");
                input.type = "number";
                input.className = "form-control";
                input.placeholder = i === 1 ? "Enter value for Y1" : (i === numberOfY ? "Enter value for Y" +
                    numberOfY : "Enter value for Y");
                input.required = true;
                input.name = "Input_for_Y" + i;
                if (i === 1) {
                    input.classList.add("firstinput");
                }
                if (i === numberOfY) {
                    input.classList.add("lastinput");
                }
                var div = document.createElement("div");
                div.className = "col-md-4";
                div.appendChild(label);
                div.appendChild(input);
                form.insertBefore(div, inputForW.nextSibling);
            }
            var calculateRow = document.createElement("div");
            calculateRow.className = "row";
            var calculateCol = document.createElement("div");
            calculateCol.className = "col-md-12";
            var calculateButton = document.createElement("button");
            calculateButton.type = "button";
            calculateButton.className = "btn btn-soft-primary calc";
            calculateButton.textContent = "Calculate";
            calculateButton.addEventListener("click", calculate);
            calculateCol.appendChild(calculateButton);
            calculateRow.appendChild(calculateCol);
            form.appendChild(calculateRow);
            document.getElementById("rowMessage").innerText = "Total number of  'Y' Inputs: " + numberOfY;
            document.getElementById("rowMessage").style.display = "block";
            setTimeout(function() {
                document.getElementById("rowMessage").style.display = "none";
            }, 1000);
        }

        function calculate() {
            var existingResults = document.querySelectorAll(".calculation-result");
            existingResults.forEach(function(result) {
                result.remove();
            });
            var inputs = document.querySelectorAll("input[name^='Input_for_Y'], input#Input_for_W");
            var oddSum = 0;
            var evenSum = 0;
            var firstInputValue = null;
            var lastInputValue = null;
            var hasEmptyField = false;
            inputs.forEach(function(input, index) {
                var value = parseFloat(input.value);
                if (!isNaN(value)) {
                    if (input.id === "Input_for_W") {
                        if (value === 0) {
                            hasEmptyField = true;
                        }
                    } else {
                        if (index === 1) {
                            firstInputValue = value;
                        } else if (index === inputs.length - 1) {
                            lastInputValue = value;
                        } else {
                            if (index % 2 === 0) {
                                evenSum += value;
                            } else {
                                oddSum += value;
                            }
                        }
                    }
                } else {
                    hasEmptyField = true;
                }
            });
            if (hasEmptyField) {
                var rowMessage = document.getElementById("rowMessage");
                rowMessage.textContent = "Please fill in all input fields (including 'W') before calculating.";
                rowMessage.style.display = "block";
                rowMessage.classList.add("alert-danger");
                setTimeout(function() {
                    document.getElementById("rowMessage").style.display = "none";
                }, 1000);
                return;
            } else {
                document.getElementById("rowMessage").classList.add("alert-success");
            }
            var odd = 4 * evenSum;
            var even = 2 * oddSum;
            var sum = (firstInputValue + lastInputValue);
            var area = (document.getElementById("Input_for_W").value / 3) * (firstInputValue + lastInputValue +
                odd + even);
            var resultContainer = document.createElement("div");
            resultContainer.className = "col-md-12 calculation-result";
            var firstInputResult = document.createElement("p");
            firstInputResult.textContent = "First Input: " + (firstInputValue !== null ? firstInputValue :
                "N/A");
            var lastInputResult = document.createElement("p");
            lastInputResult.textContent = "Last Input: " + (lastInputValue !== null ? lastInputValue : "N/A");
            var oddSumResult = document.createElement("p");
            oddSumResult.textContent = "Sum of Even Inputs: " + oddSum;
            var evenSumResult = document.createElement("p");
            evenSumResult.textContent = "Sum of Odd Inputs: " + evenSum;
            var areaResult = document.createElement("p");
            var areaRounded = area.toFixed(2);
            var inputValues = {};
            inputs.forEach(function(input, index) {
                var value = parseFloat(input.value);
                if (!isNaN(value)) {
                    var name = input.name === "" ? "Input_for_W" : input.name;
                    inputValues[input.name] = value;
                }
            });
            if (typeof inputValues["Input_for_W"] === "undefined") {
                inputValues["Input_for_W"] = inputValues[""];
                delete inputValues[""];
            }
            var inputForYDefValue = parseInt($("#Input_for_Y_def").val());
            inputValues["Input_for_def_Y"] = parseFloat(inputForYDefValue);
            inputValues["parent_id"] = '{!! $unit_id !!}';
            inputValues["currentId"] = currentId;
            inputValues["type"] = "Simpson-rule";
            inputValues["btntype"] = 1;
            inputValues["unit"] = "Cum";
            inputValues["overallTotal"] = areaRounded;
            inputValues["editEstimate_id"] = editEstimate_Id;
            var ruledata = {
                input_values: inputValues
            };
            $.ajax({
                url: '/store-unit-modal-rule-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    data: ruledata
                }),
                success: function(response) {
                    $('.rowCheckbox').prop('checked', false);
                    var form = document.getElementById("simpsonsRuleForm");
                    form.reset();
                    var tableBody1 = $("#dataTable tbody");
                    tableBody1.empty();
                    var rateAnalysisArray1 = response.rateAnalysisArray[unitId]['metadata'];
                    if ($.isEmptyObject(rateAnalysisArray1)) {
                        $("#close-unit-modalBtn").html("Close");
                    }
                    var tableBody = $("#dataTable1 tbody");
                    tableBody.empty();
                    var sno = 0;
                    type = null;
                    $.each(rateAnalysisArray1, function(index, metadata) {
                        var newRow = $("<tr>");
                        newRow.append(
                            '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                        );
                        newRow.append('<td style="text-align:center;">A' + (sno + 1) +
                            '</td>');
                        newRow.append('<td style="text-align:center;">' +
                            metadata.type + (metadata.remarks ? ' (' +
                                metadata.remarks + ')' : '') +
                            '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata
                            .overallTotal + '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata.unit +
                            '</td>');

                        var editButtonClass = '';
                        if (metadata.btntype === 1) {
                            editButtonClass = 'editBtnrule';
                        } else if (metadata.btntype === 2) {
                            editButtonClass = 'editBtn';
                        } else if (metadata.btntype === 3) {
                            editButtonClass = 'defaultbtn';
                        } else if (metadata.btntype === 4) {
                            editButtonClass = 'sabtn';
                        } else if (metadata.btntype === 5) {
                            editButtonClass = 'apcbtn';
                        } else if (metadata.btntype === 6) {
                            editButtonClass = 'vcbtn';
                        }
                        var editButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                editButtonClass,
                            'data-id': metadata.currentId
                        }).text('edit');
                        var deleteButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-danger btn-sm delBtn',
                            'data-id': metadata.currentId
                        }).text('Delete');
                        var grandTotalValue = metadata.grandTotal;
                        var hiddenInput = $('<input>').attr({
                            'type': 'hidden',
                            'id': 'metagrandval',
                            'value': grandTotalValue
                        });
                        var buttonCell = $('<td>').css('text-align', 'center')
                            .append(editButton).append(' ').append(deleteButton);
                        if (metadata.hasOwnProperty('key')) {
                            editButton.remove();
                            tableBody.find('.delBtn').remove();
                            buttonCell.append(deleteButton);
                        }
                        if (metadata.hasOwnProperty('expcalculate')) {
                            $("#finalSubmitBtn").prop("disabled", false);
                            $("#close-unit-modalBtn").html("Reset & close");
                        } else {
                            $("#finalSubmitBtn").prop("disabled", true);
                            $("#close-unit-modalBtn").html("Reset & close");
                        }
                        newRow.append(hiddenInput).append(buttonCell);
                        tableBody.append(newRow);
                        sno++;
                        $('#grandTotalInput').val(metadata.grandTotal !== undefined &&
                            metadata.grandTotal !== null ? metadata.grandTotal : 0);

                    });
                    if (tableBody.find('tr').length > 0) {
                        $('#mySelect').hide();
                        $('#metagrandtotal').show();
                    } else {
                        $('#mySelect').show();
                        $('#metagrandtotal').hide();
                    }
                    $('#successAlert').text('Rule Added successfully');
                    $('#successAlert').addClass('alert-success').removeClass('alert-danger')
                        .show();
                    //  $("#close-unit-modalBtn").html("Reset & close");
                    //$("#finalSubmitBtn").prop("disabled", false);
                    setTimeout(function() {
                        $('#successAlert').hide();
                    }, 2000);
                    $('.rowCheckbox').prop('checked',
                        false);
                    $("#totalOnSelected").prop("disabled", true);
                    $('.optionDropdown button.dropdown-toggle').prop('disabled', false);
                    $("#calexp").prop("disabled", false);
                    $('#additionalFields').hide();
                    // $('#myForm').hide();
                    // $('#Area-perimeter-rectangle').hide();
                    // $('#Area-perimeter-circle').hide();
                    // $('#surfaceArea-volume-rectangle').hide();
                    var form = document.getElementById("simpsonsRuleForm");
                    form.reset();
                    currentId = null;
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
            areaResult.textContent = "Area: " + areaRounded + " cm^3";
            resultContainer.appendChild(firstInputResult);
            resultContainer.appendChild(lastInputResult);
            resultContainer.appendChild(oddSumResult);
            resultContainer.appendChild(evenSumResult);
            resultContainer.appendChild(areaResult);
            var form = document.getElementById("simpsonsRuleForm");
        }
        $(document).on("click", ".editBtnrule", function() {
            currentId = this.getAttribute("data-id");
            $.ajax({
                url: '/get-modal-rule-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    unitId: unitId,
                    ruleId: currentId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    if (response.status) {
                        $('#additionalFields').show();
                        $('#myForm').hide();
                        $('#Area-perimeter-rectangle').hide();
                        $('#Area-perimeter-circle').hide();
                        $('#surfaceArea-volume-rectangle').hide();
                        //  $("#close-unit-modalBtn").html("Reset & close");
                        // $("#finalSubmitBtn").prop("disabled", false);
                        $('.rowCheckbox').prop('checked', false);
                        var sessionData = response.rateAnalysisArray;
                        document.getElementById("Input_for_W").value = sessionData[
                            'input_values']['Input_for_W'];
                        document.getElementById("Input_for_Y_def").value = sessionData[
                            'input_values']['Input_for_def_Y'];
                        var existingYInputs = document.querySelectorAll(
                            "input[name^='Input_for_Y']");
                        existingYInputs.forEach(function(input) {
                            input.parentNode.remove();
                        });
                        var numberOfYInputs = Object.keys(sessionData['input_values'])
                            .filter(
                                key => key.startsWith("Input_for_Y")).length;
                        for (var i = numberOfYInputs; i >= 1; i--) {
                            var label = document.createElement("label");
                            label.textContent = "Input for Y" + i;
                            var input = document.createElement("input");
                            input.type = "number";
                            input.className = "form-control";
                            input.placeholder = "Enter value for Y" + i;
                            input.required = true;
                            input.name = "Input_for_Y" + i;
                            if (sessionData['input_values']["Input_for_Y" + i]) {
                                input.value = sessionData['input_values']["Input_for_Y" +
                                    i
                                ];
                            }
                            var div = document.createElement("div");
                            div.className = "col-md-6";
                            div.appendChild(label);
                            div.appendChild(input);
                            document.getElementById("simpsonsRuleForm").insertBefore(div,
                                document
                                .getElementById("Input_for_W").parentNode.nextSibling);
                        }
                        var existingCalculateButton = document.querySelector(".calc");
                        if (existingCalculateButton) {
                            existingCalculateButton.parentNode.remove();
                        }
                        var calculateRow = document.createElement("div");
                        calculateRow.className = "row";
                        var calculateCol = document.createElement("div");
                        calculateCol.className = "col-md-12";
                        var calculateButton = document.createElement("button");
                        calculateButton.type = "button";
                        calculateButton.className = "btn btn-soft-primary  calc";
                        calculateButton.textContent = "Calculate";
                        calculateButton.addEventListener("click", calculate);
                        calculateCol.appendChild(calculateButton);
                        calculateRow.appendChild(calculateCol);
                        document.getElementById("simpsonsRuleForm").appendChild(
                            calculateRow);
                    } else {
                        console.error('Error:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });

        function resetResults() {
            if (firstInputResult) firstInputResult.textContent = '';
            if (lastInputResult) lastInputResult.textContent = '';
            if (oddSumResult) oddSumResult.textContent = '';
            if (evenSumResult) evenSumResult.textContent = '';
            if (areaResult) areaResult.textContent = '';
        }




        // $(document).delegate(
        //     "input[name='length'], input[name='breadth'], input[name='height'], input[name='number']",
        //     "input",
        //     function() {
        //         var row = $(this).closest("tr");
        //         calculateTotal(row);
        //         updateTotalSum();
        //     });
        function updateTotalSum() {
            var sum = 0;
            $("#dataTable tbody tr").each(function() {
                var total = parseFloat($(this).find('.total').val()) || 0;
                sum += total;
            });
            $("#totalSum").val(sum.toFixed(3));
        }
        $(document).on('input',
            'input[name="length"], input[name="breadth"], input[name="height"], input[name="number"]',
            function() {
                var row = $(this).closest("tr");
                calculateTotal(row);
                updateTotalSum();
            });

        function addNewRow() {
            var unitOptions = '<option value="">Select Unit</option>';
            <?php foreach ($unitMaster as $unit): ?>
            unitOptions += '<option value="<?php echo $unit['short_name']; ?>"><?php echo $unit['short_name']; ?></option>';
            <?php endforeach; ?>
            var newRow = $('<tr>' +
                '<td>' + ($("#dataTable tbody tr").length + 1) + '</td>' +
                '<td><input type="text" class="form-control m-input member" name="member" placeholder="Member" /></td>' +
                '<td><input type="number" class="form-control m-input number" name="number" placeholder="Number" /></td>' +
                '<td><div class="input-group">' +
                '<input type="number" class="form-control m-input length" name="length" placeholder="Length" />' +
                '<button type="button" class="btn btn-soft-danger remove-field-btn length">X</button>' +
                '<button type="button" class="btn btn-soft-primary add-btn-length"> + add length</button>' +
                '</div></td>' +
                '<td><div class="input-group">' +
                '<input type="number" class="form-control m-input breadth" name="breadth" placeholder="Breadth" />' +
                '<button type="button" class="btn btn-soft-danger remove-field-btn breadth">X</button>' +
                '<button type="button" class="btn btn-soft-primary add-btn-breadth">+ add breadth</button>' +
                '</div></td>' +
                '<td><div class="input-group">' +
                '<input type="number" class="form-control m-input height" name="height" placeholder="Height" />' +
                '<button type="button" class="btn btn-soft-danger remove-field-btn height">X</button>' +
                '<button type="button" class="btn btn-soft-primary add-btn-height">+ add height</button>' +
                '</div></td>' +
                '<td><select class="form-control m-input unit" name="unit">' + unitOptions +
                '</select></td>' +
                '<td><input type="text" class="form-control m-input total" name="total" placeholder="Total" value="00.00" readonly/></td>' +
                '<td class="button-cell">' +
                '<button type="button" class="btn-close delete-row-btn">x</button>' +
                '<button type="button" class="btn-add addbtn">+</button>' +
                '</td>' +
                '</tr>');
            newRow.find(
                '.length, .remove-field-btn.length, .breadth, .remove-field-btn.breadth, .height, .remove-field-btn.height'
            ).hide();

         
            newRow.find('.remove-field-btn').click(function() {
                var inputGroup = $(this).closest('td').find('.form-control');
                inputGroup.val('').hide();
                $(this).hide();
                var row = $(this).closest('tr');
                calculateTotal(row);

                    // Check the specific class of the input field
                    var inputClass = inputGroup.attr('class');
                    if (inputClass.includes('length') && inputGroup.val() === '') {
                        $(this).siblings('.add-btn-length').show();
                    } else if (inputClass.includes('breadth') && inputGroup.val() === '') {
                        $(this).siblings('.add-btn-breadth').show();
                    } else if (inputClass.includes('height') && inputGroup.val() === '') {
                        $(this).siblings('.add-btn-height').show();
                    }
                
            });


            newRow.find('.add-btn-length').click(function() {
                var inputGroup = $(this).parent();
                var removeBtn = inputGroup.find('.remove-field-btn');
                var lengthInput = inputGroup.find('.length');
                lengthInput.removeClass('hidden').show();
                $(this).hide();
                removeBtn.show();
            });

            newRow.find('.add-btn-breadth').click(function() {
                var inputGroup = $(this).parent();
                var removeBtn = inputGroup.find('.remove-field-btn');
                var breadthInput = inputGroup.find('.breadth');
                breadthInput.removeClass('hidden').show();
                $(this).hide();
                removeBtn.show();
            });

            newRow.find('.add-btn-height').click(function() {
                var inputGroup = $(this).parent();
                var removeBtn = inputGroup.find('.remove-field-btn');
                var heightInput = inputGroup.find('.height');
                heightInput.removeClass('hidden').show();
                $(this).hide();
                removeBtn.show();
            });

            newRow.find('input[type="number"]').on('input', function() {
                var value = $(this).val();
                if (value !== "" && !isNaN(value)) {
                    if (value.startsWith('.')) {
                        $(this).val('0' + value);
                    } else if (value === '0') {
                        $(this).val(value);
                    }
                }
            });
            $("#dataTable tbody").append(newRow);
            newRow.find('.length, .breadth, .height, .number').trigger('input');
            updateButtons();
            updateTotalSum();
        }
        function updateButtons() {
            var tableRows = $("#dataTable tbody tr");
            tableRows.find(".delete-row-btn").hide();
            tableRows.last().find(".delete-row-btn").show();
            tableRows.find(".addbtn").hide();
            tableRows.last().find(".addbtn").show();
            if (tableRows.length === 1) {
                tableRows.find(".delete-row-btn").hide();
            }
        }
        $(document).off("click", ".addbtn").on("click", ".addbtn", function() {
            var lastRow = $("#dataTable tbody tr:last");
            var newRow = lastRow.clone();
            var rowIndex = $("#dataTable tbody tr").length + 1;
            newRow.find('td:first').text(rowIndex);

            // Update the selected value of the cloned select element
            var selectedUnit = lastRow.find('.unit').val();
            newRow.find('.unit').val(selectedUnit);

            // Append the cloned row to the table body
            $("#dataTable tbody").append(newRow);

            // Manually trigger input event on input fields to update total sum
            newRow.find('.length, .breadth, .height, .number').trigger('input');

            updateButtons();
            updateTotalSum();
            $("#close-unit-modalBtn").html("Reset & close");
        });


        $(document).on("click", ".delete-row-btn", function() {
            if ($("#dataTable tbody tr").length > 1) {
                $(this).closest("tr").remove();
                updateRowNumbers();
                updateButtons();
                updateTotalSum();
            }
        });

        function updateRowNumbers() {
            $("#dataTable tbody tr").each(function(index) {
                $(this).find("td:first").text(index + 1);
            });
        }


        $('.length, .breadth, .height, .number').on('keyup change', function() {
            var row = $(this).closest('tr');
            calculateTotal(row);
        });


        function calculateTotal(row) {
            var lengthInput = row.find('.length');
            var breadthInput = row.find('.breadth');
            var heightInput = row.find('.height');
            var numberInput = row.find('.number');

            // Check if any of the input values are zero for visible fields only
            if (!lengthInput.hasClass('hidden') && !breadthInput.hasClass('hidden') &&
                !heightInput.hasClass('hidden') && !numberInput.hasClass('hidden')) {
                var length = parseFloat(lengthInput.val()) || 1;
                var breadth = parseFloat(breadthInput.val()) || 1;
                var height = parseFloat(heightInput.val()) || 1;
                var number = parseFloat(numberInput.val()) || 1;

                if (length === 0 || breadth === 0 || height === 0 || number === 0) {
                    alert('Input values cannot be 0.');
                    return;
                }
            }

            var total = length * breadth * height * number;

            // Set the total value with proper formatting
            var totalValue = total.toFixed(2);

            if (totalValue == 1) {
                totalValue = '0.00';
            }

            // Set the total value in the corresponding input field
            row.find('.total').val(totalValue);
            updateTotalSum();
        }

        $("#myForm").submit(function(event) {
            event.preventDefault();
            $(".empty-field").tooltip("dispose");
            var isEmpty = false;
            var hasZeroValue = false;

            $("#dataTable tbody tr").each(function() {
                var row = $(this);
                var emptyFields = [];

                row.find("input, select").each(function() {
                    var field = $(this);
                    if (!field.val() && (!field.hasClass("hidden") && !field.is(
                            ":hidden"))) { // Skip hidden and display:none fields
                        if (!field.hasClass("total")) {
                            isEmpty = true;
                            emptyFields.push(field);
                            field.tooltip({
                                title: "Required field and cannot be Zero(0)",
                                placement: "bottom",
                                trigger: "manual"
                            });
                            field.hover(function() {
                                $(this).tooltip("show");
                            }, function() {
                                $(this).tooltip("hide");
                            });
                        }
                    } else if (parseFloat(field.val()) === 0 && (!field.hasClass(
                            "hidden") && !field.is(
                            ":hidden"))) { // Skip hidden and display:none fields
                        hasZeroValue = true;
                    } else {
                        field.removeClass("empty-field");
                        field.tooltip("dispose");
                    }
                });

                if (emptyFields.length > 0) {
                    row.addClass("has-empty-field");
                    emptyFields.forEach(function(field) {
                        field.addClass("empty-field");
                    });
                } else {
                    row.removeClass("has-empty-field");
                }
            });

            if (isEmpty || hasZeroValue) {
                if (hasZeroValue) {
                    alert("Input values cannot be 0.");
                }
                return;
            }

            var form = this;
            var rowData = [];
            var totalSum = parseFloat($("#totalSum").val()) || 0;
            $("#dataTable tbody tr").each(function() {
                var row = {};
                $(this).find("input,select").each(function() {
                    var name = $(this).attr("name");
                    var value = $(this).val();
                    row[name] = value;
                });
                row['type'] = "other";
                row['btntype'] = 2;
                row['parent_id'] = unitId;
                row['currentId'] = currentId !== undefined && currentId !== null ?
                    currentId : currentId === '' ? '' : null;
                row['overallTotal'] = totalSum;

                row['editEstimate_id'] = editEstimate_Id;

                rowData.push(row);
            });

            //console.log(rowData);
            $.ajax({
                url: '/store-dynamic-unit-modal-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    data: rowData,
                }),
                success: function(response) {
                    var tableBody1 = $("#dataTable tbody");
                    tableBody1.empty();
                    var rateAnalysisArray1 = response.rateAnalysisArray[unitId]['metadata'];
                    if ($.isEmptyObject(rateAnalysisArray1)) {
                        $("#close-unit-modalBtn").html("Close");
                    }
                    var tableBody = $("#dataTable1 tbody");
                    tableBody.empty();
                    var sno = 0;
                    $.each(rateAnalysisArray1, function(index, metadata) {
                        var newRow = $("<tr>");
                        newRow.append(
                            '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                        );
                        newRow.append('<td style="text-align:center;">A' + (sno +
                            1) + '</td>');
                        newRow.append('<td style="text-align:center;">' +
                            metadata.type + (metadata.remarks ? ' (' +
                                metadata.remarks + ')' : '') +
                            '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata
                            .overallTotal + '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata
                            .unit + '</td>');

                        var editButtonClass = '';
                        if (metadata.btntype === 1) {
                            editButtonClass = 'editBtnrule';
                        } else if (metadata.btntype === 2) {
                            editButtonClass = 'editBtn';
                        } else if (metadata.btntype === 3) {
                            editButtonClass = 'defaultbtn';
                        } else if (metadata.btntype === 4) {
                            editButtonClass = 'sabtn';
                        } else if (metadata.btntype === 5) {
                            editButtonClass = 'apcbtn';
                        } else if (metadata.btntype === 6) {
                            editButtonClass = 'vcbtn';
                        }
                        var editButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                editButtonClass,
                            'data-id': metadata.currentId
                        }).text('edit');
                        var deleteButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-danger btn-sm delBtn',
                            'data-id': metadata.currentId
                        }).text('Delete');
                        var grandTotalValue = metadata.grandTotal;
                        var hiddenInput = $('<input>').attr({
                            'type': 'hidden',
                            'id': 'metagrandval',
                            'value': grandTotalValue
                        });
                        var buttonCell = $('<td>').css('text-align', 'center')
                            .append(editButton).append(' ').append(deleteButton);
                        if (metadata.hasOwnProperty('key')) {
                            editButton.remove();
                            tableBody.find('.delBtn').remove();
                            buttonCell.append(deleteButton);
                        }
                        if (metadata.hasOwnProperty('expcalculate')) {
                            $("#finalSubmitBtn").prop("disabled", false);
                            $("#close-unit-modalBtn").html("Reset & close");
                        } else {
                            $("#finalSubmitBtn").prop("disabled", true);
                            $("#close-unit-modalBtn").html("Reset & close");
                        }
                        newRow.append(hiddenInput).append(buttonCell);
                        tableBody.append(newRow);
                        sno++;
                        $('#grandTotalInput').val(metadata.grandTotal !==
                            undefined && metadata.grandTotal !== null ? metadata
                            .grandTotal : 0);
                    });
                    currentId = null;
                    addNewRow();
                    updateTotalSum();
                    if (tableBody.find('tr').length > 0) {
                        $('#mySelect').hide();
                        $('#metagrandtotal').show();
                    } else {
                        $('#mySelect').show();
                        $('#metagrandtotal').hide();
                    }
                    $('#successAlert').text('Row Added successfully');
                    $('#successAlert').addClass('alert-success').removeClass('alert-danger')
                        .show();
                    setTimeout(function() {
                        $('#successAlert').hide();
                    }, 2000);
                    //  $("#close-unit-modalBtn").html("Reset & close");
                    // $("#finalSubmitBtn").prop("disabled", false);
                    $('.rowCheckbox').prop('checked', false);
                    $('.optionDropdown button.dropdown-toggle').prop('disabled', false);
                    $("#calexp").prop("disabled", false);
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        $(document).off("click", "#submitBtn").on("click", "#submitBtn", function() {
            $("#myForm").submit();
            // $("#finalSubmitBtn").prop("disabled", false);
            $("#close-unit-modalBtn").html("Reset & close");
            $('.rowCheckbox').prop('checked', false);
        });
        $(document).on("click", ".editBtn", function() {
            $('.rowCheckbox').prop('checked', false);
            $("#close-unit-modalBtn").html("Reset & close");
            $("#finalSubmitBtn").prop("disabled", false);
            $('#additionalFields').hide();
            $('#Area-perimeter-rectangle').hide();
            $('#Area-perimeter-circle').hide();
            $('#surfaceArea-volume-rectangle').hide();
            $('#myForm').show();
            var metadataId = $(this).data("id");
            editRow(metadataId);
        });
        $(document).off("click", ".delBtn").on("click", ".delBtn", function() {
            var confirmed = confirm("Are you sure you want to delete this row?");
            if (confirmed) {
                $('#additionalFields').hide();
                $('#myForm').hide();
                var metadataId = $(this).data("id");
                $("#close-unit-modalBtn").html("Reset & close");
                $("#totalOnSelected").prop("disabled", false);
                $('.rowCheckbox').prop('checked', false);
                $("#calexp").prop("disabled", false);
                deleteRow(metadataId);
            }
        });

        function deleteRow(rowId) {
            $.ajax({
                url: '/delete-unit-modal-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    rowId: rowId,
                    parent_id: unitId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    var tableBody1 = $("#dataTable tbody");
                    tableBody1.empty();
                    var rateAnalysisArray1 = response.rateAnalysisArray[unitId]['metadata'];
                    if ($.isEmptyObject(rateAnalysisArray1)) {
                        $("#close-unit-modalBtn").html("Close");
                    }
                    var hasKey = false;
                    for (var i = 0; i < rateAnalysisArray1.length; i++) {
                        if (rateAnalysisArray1[i].key) {
                            hasKey = true;
                            break;
                        }
                    }
                    var tableBody = $("#dataTable1 tbody");
                    tableBody.empty();
                    var sno = 0;
                    $.each(rateAnalysisArray1, function(index, metadata) {
                        var newRow = $("<tr>");
                        newRow.append(
                            '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                        );
                        newRow.append('<td style="text-align:center;">A' + (sno + 1) +
                            '</td>');
                        newRow.append('<td style="text-align:center;">' +
                            metadata.type + (metadata.remarks ? ' (' +
                                metadata.remarks + ')' : '') +
                            '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata
                            .overallTotal + '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata.unit +
                            '</td>');
                        var editButtonClass = '';
                        if (metadata.btntype === 1) {
                            editButtonClass = 'editBtnrule';
                        } else if (metadata.btntype === 2) {
                            editButtonClass = 'editBtn';
                        } else if (metadata.btntype === 3) {
                            editButtonClass = 'defaultbtn';
                        } else if (metadata.btntype === 4) {
                            editButtonClass = 'sabtn';
                        } else if (metadata.btntype === 5) {
                            editButtonClass = 'apcbtn';
                        } else if (metadata.btntype === 6) {
                            editButtonClass = 'vcbtn';
                        }
                        var editButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                editButtonClass,
                            'data-id': metadata.currentId
                        }).text('edit');
                        var deleteButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-danger btn-sm delBtn',
                            'data-id': metadata.currentId
                        }).text('Delete');
                        var grandTotalValue = metadata.grandTotal;
                        var hiddenInput = $('<input>').attr({
                            'type': 'hidden',
                            'id': 'metagrandval',
                            'value': grandTotalValue
                        });
                        var buttonCell = $('<td>').css('text-align', 'center')
                            .append(editButton).append(' ').append(deleteButton);
                        if (metadata.hasOwnProperty('key')) {
                            editButton.remove();
                            tableBody.find('.delBtn').remove();
                            buttonCell.append(deleteButton);
                        }
                        if (metadata.hasOwnProperty('expcalculate')) {
                            $("#finalSubmitBtn").prop("disabled", false);
                            $("#close-unit-modalBtn").html("Reset & close");
                        } else {
                            $("#finalSubmitBtn").prop("disabled", true);
                            $("#close-unit-modalBtn").html("Reset & close");
                        }
                        newRow.append(hiddenInput).append(buttonCell);
                        tableBody.append(newRow);
                        sno++;
                        $('#grandTotalInput').val(metadata.grandTotal !== undefined &&
                            metadata.grandTotal !== null ? metadata.grandTotal : 0);
                    });
                    addNewRow();
                    updateTotalSum();
                    if (tableBody.find('tr').length > 0) {
                        $('#mySelect').hide();
                        $('#metagrandtotal').show();
                    } else {
                        $('#mySelect').show();
                        $('#metagrandtotal').hide();
                    }
                    $('#successAlert').text('Row deleted successfully');
                    $('#successAlert').addClass('alert-danger').removeClass('alert-success')
                        .show();
                    // $("#finalSubmitBtn").prop("disabled", false);
                    setTimeout(function() {
                        $('#successAlert').hide();
                    }, 2000);
                    $('.rowCheckbox').prop('checked',
                        false);
                    $('#Area-perimeter-circle').trigger('reset');
                    $('#Area-perimeter-circle').hide();
                    $('#surfaceArea-volume-rectangle').hide();
                    $('#Area-perimeter-rectangle').hide();
                    $('#additionalFields').hide();
                    $('#myForm').hide();
                    $('#surfaceArea-volume-rectangle').trigger('reset');
                    currentId = null;
                    $("#calexp").prop("disabled", false);
                    $('.optionDropdown button.dropdown-toggle').prop('disabled', false);
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        }


        function checkInputs() {
            var isEmpty = false;
            $("#dataTable tbody input").each(function() {
                if ($(this).val() === '') {
                    isEmpty = true;
                    return false; // Exit the loop early if an empty input is found
                }
            });
            return isEmpty;
        }

        function updateButtons() {
            var tableRows = $("#dataTable tbody tr");
            tableRows.find(".delete-row-btn").hide();
            tableRows.last().find(".delete-row-btn").show();
            tableRows.find(".addbtn").hide();
            tableRows.last().find(".addbtn").show();
            if (tableRows.length === 1) {
                tableRows.find(".delete-row-btn").hide();
            }
            $('#dataTable tbody tr').each(function() {
                var lengthInput = $(this).find('.length');
                var breadthInput = $(this).find('.breadth');
                var heightInput = $(this).find('.height');
                var addLengthBtn = $(this).find('.add-btn-length');
                var addBreadthBtn = $(this).find('.add-btn-breadth');
                var addHeightBtn = $(this).find('.add-btn-height');
                var removeLengthBtn = $(this).find('.remove-field-btn.length');
                // console.log(removeLengthBtn);
                var removeBreadthBtn = $(this).find('.remove-field-btn.breadth');
                var removeHeightBtn = $(this).find('.remove-field-btn.height');


                // Check if length input is empty
                if (lengthInput.val() === '' || lengthInput.val() === null) {
                    //alert("length");
                    lengthInput.hide();
                    addLengthBtn.show();
                    removeLengthBtn.hide();
                } else {
                    lengthInput.show();
                    addLengthBtn.hide();
                    removeLengthBtn.show();
                }

                // Check if breadth input is empty
                if (breadthInput.val() === '' || lengthInput.val() === null) {
                    // alert("breadth");
                    breadthInput.hide();
                    addBreadthBtn.show();
                    removeBreadthBtn.hide();
                } else {
                    breadthInput.show();
                    addBreadthBtn.hide();
                    removeBreadthBtn.show();
                }

                // Check if height input is empty
                if (heightInput.val() === '' || lengthInput.val() === null) {
                    // alert("height");
                    heightInput.hide();
                    addHeightBtn.show();
                    removeHeightBtn.hide();
                } else {
                    heightInput.show();
                    addHeightBtn.hide();
                    removeHeightBtn.show();
                }
            });
        }




        updateButtons();


        $("#dataTable tbody").on('input', 'input', function() {
            updateButtons(); // Call the function whenever any input value changes
        });

        function editRow(rowId) {
            currentId = rowId;
            $.ajax({
                url: '/unit-modal-updated-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    rowId: rowId,
                    parent_id: unitId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    var tableBody1 = $("#dataTable tbody");
                    tableBody1.empty();
                    var rateAnalysisArray = response.rateAnalysisArray;
                    console.log(rateAnalysisArray);
                    rateAnalysisArray.forEach(function(rowData, index) {
                        var unitOptions = '<option value="">Select Unit</option>';
                        <?php foreach ($unitMaster as $unit): ?>
                        var selected = (rowData && rowData.unit === "<?php echo $unit['short_name']; ?>");
                        unitOptions += '<option value="<?php echo $unit['short_name']; ?>"' + (selected ?
                                ' selected' : '') +
                            '><?php echo $unit['short_name']; ?></option>';
                        <?php endforeach; ?>
                        var newRow = $('<tr>' +
                            '<td>' + (index + 1) + '</td>' +
                            '<td><input type="text" class="form-control m-input member" name="member" value="' +
                            (rowData && rowData.member ? rowData.member : '') +
                            '" placeholder="Member" required/></td>' +
                            '<td><input type="number" class="form-control m-input number" name="number" value="' +
                            (rowData && rowData.number ? rowData.number : '') +
                            '" placeholder="Number" required/></td>' +
                            '<td>' +
                            '<div class="input-group">' +
                            '<input type="number" class="form-control m-input length" name="length" value="' +
                            (rowData && rowData.length ? rowData.length : '') +
                            '" placeholder="Length" required/>' +
                            '<div class="input-group-append">' +
                            '<button type="button" class="btn btn-soft-danger remove-field-btn length">X</button>' +
                            '<button type="button" class="btn btn-soft-primary add-btn-length">+ add length</button>' +
                            '</div>' +
                            '</div>' +
                            '</td>' +
                            '<td>' +
                            '<div class="input-group">' +
                            '<input type="number" class="form-control m-input breadth" name="breadth" value="' +
                            (rowData && rowData.breadth ? rowData.breadth : '') +
                            '" placeholder="Breadth" required/>' +
                            '<div class="input-group-append">' +
                            '<button type="button" class="btn btn-soft-danger remove-field-btn breadth">X</button>' +
                            '<button type="button" class="btn btn-soft-primary add-btn-breadth">+ add breadth</button>' +
                            '</div>' +
                            '</div>' +
                            '</td>' +
                            '<td>' +
                            '<div class="input-group">' +
                            '<input type="number" class="form-control m-input height" name="height" value="' +
                            (rowData && rowData.height ? rowData.height : '') +
                            '" placeholder="Height" required/>' +
                            '<div class="input-group-append">' +
                            '<button type="button" class="btn btn-soft-danger remove-field-btn height">X</button>' +
                            '<button type="button" class="btn btn-soft-primary add-btn-height">+ add height</button>' +
                            '</div>' +
                            '</div>' +
                            '</td>' +
                            '<td><select class="form-control m-input unit" name="unit">' +
                            unitOptions + '</select></td>' +
                            '<td><input type="text" class="form-control m-input total" name="total" value="' +
                            (rowData && rowData.total ? rowData.total : 0.00) +
                            '" placeholder="Total" readonly/></td>' +
                            '<td class="button-cell">' +
                            '<button type="button" class="btn-close delete-row-btn">x</button>' +
                            '<button type="button" class="btn-add addbtn">+</button>' +
                            '</td>' +
                            '</tr>');

                        tableBody1.append(newRow);
                    });

                    updateTotalSum(); // Update total sum after populating the table
                    updateButtons(); // Update button visibility after populating the table
                    $('.rowCheckbox').prop('checked', false);
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        }


        $("#dataTable tbody").on('click', '.remove-field-btn', function() {
            var inputGroup = $(this).closest('td').find('.form-control');
            inputGroup.val('').hide();
            $(this).hide();
            var row = $(this).closest('tr');
            calculateTotall(row);
            // Check the specific class of the input field
            var inputClass = inputGroup.attr('class');
            if (inputClass.includes('length') && inputGroup.val() === '') {
                $(this).siblings('.add-btn-length').show();
            } else if (inputClass.includes('breadth') && inputGroup.val() === '') {
                $(this).siblings('.add-btn-breadth').show();
            } else if (inputClass.includes('height') && inputGroup.val() === '') {
                $(this).siblings('.add-btn-height').show();
            }

        });


        function calculateTotall(row) {
            var lengthInput = row.find('.length');
            var breadthInput = row.find('.breadth');
            var heightInput = row.find('.height');
            var numberInput = row.find('.number');

            // Check if any of the input values are zero for visible fields only
            if (!lengthInput.hasClass('hidden') && !breadthInput.hasClass('hidden') &&
                !heightInput.hasClass('hidden') && !numberInput.hasClass('hidden')) {
                var length = parseFloat(lengthInput.val()) || 1;
                var breadth = parseFloat(breadthInput.val()) || 1;
                var height = parseFloat(heightInput.val()) || 1;
                var number = parseFloat(numberInput.val()) || 1;

                if (length === 0 || breadth === 0 || height === 0 || number === 0) {
                    alert('Input values cannot be 0.');
                    return;
                }
            }

            var total = length * breadth * height * number;

            // Set the total value with proper formatting
            var totalValue = total.toFixed(2);
            if (isNaN(totalValue)) {
                totalValue = '0.00';
            }

            // Set the total value in the corresponding input field
            row.find('.total').val(totalValue);
        }

        $("#dataTable tbody").on('click', '.add-btn-length', function() {
            var inputGroup = $(this).closest('td').find('.form-control');
            inputGroup.show();
            $(this).hide();
            $(this).siblings('.remove-field-btn').show();
        });

        $("#dataTable tbody").on('click', '.add-btn-breadth', function() {
            var inputGroup = $(this).closest('td').find('.form-control');
            inputGroup.show();
            $(this).hide();
            $(this).siblings('.remove-field-btn').show();
        });

        $("#dataTable tbody").on('click', '.add-btn-height', function() {
            var inputGroup = $(this).closest('td').find('.form-control');
            inputGroup.show();
            $(this).hide();
            $(this).siblings('.remove-field-btn').show();
        });
        $("#dataTable tbody").on('input', '.form-control', function() {
            var value = $(this).val();
            if (value !== "" && !isNaN(value)) {
                if (value.startsWith('.')) {
                    $(this).val('0' + value);
                } else if (value === '0') {
                    $(this).val(value);
                }
            }
        });



        $('.dropdown').on('click', '.prev-data', function(event) {
            event.preventDefault();
            var selected_parent_id = $(this).text();
            if (editEstimate_Id) {
                var modalData = {!! json_encode(session('editModalData')) !!};
            } else {
                var modalData = {!! json_encode(session('modalData')) !!};
            }
            var selected_parent_id_Data = modalData[selected_parent_id];
            $.ajax({
                url: '/unit-modal-prev-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    data: selected_parent_id_Data,
                    parent_id: unitId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    var rateAnalysisArray2 = response.rateAnalysisArray[unitId]['metadata'];
                    if ($.isEmptyObject(rateAnalysisArray2)) {
                        $("#close-unit-modalBtn").html("Close");
                    }
                    var tableBody = $("#dataTable1 tbody");
                    tableBody.empty();
                    var sno = 0;
                    var grandTotal = 0;
                    $.each(rateAnalysisArray2, function(index, metadata) {
                        var newRow = $("<tr>");
                        newRow.append(
                            '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                        );
                        newRow.append('<td style="text-align:center;">A' + (sno +
                            1) + '</td>');
                        newRow.append('<td style="text-align:center;">' +
                            metadata.type + (metadata.remarks ? ' (' +
                                metadata.remarks + ')' : '') +
                            '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata
                            .overallTotal + '</td>');
                        newRow.append('<td style="text-align:center;">' + metadata
                            .unit + '</td>');
                        var editButtonClass = '';
                        if (metadata.btntype === 1) {
                            editButtonClass = 'editBtnrule';
                        } else if (metadata.btntype === 2) {
                            editButtonClass = 'editBtn';
                        } else if (metadata.btntype === 3) {
                            editButtonClass = 'defaultbtn';
                        } else if (metadata.btntype === 4) {
                            editButtonClass = 'sabtn';
                        } else if (metadata.btntype === 5) {
                            editButtonClass = 'apcbtn';
                        } else if (metadata.btntype === 6) {
                            editButtonClass = 'vcbtn';
                        }
                        var editButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                editButtonClass,
                            'data-id': metadata.currentId
                        }).text('edit');
                        var deleteButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-danger btn-sm delBtn',
                            'data-id': metadata.currentId
                        }).text('Delete');
                        var grandTotalValue = metadata.grandTotal;
                        var hiddenInput = $('<input>').attr({
                            'type': 'hidden',
                            'id': 'metagrandval',
                            'value': grandTotalValue
                        });
                        var buttonCell = $('<td>').css('text-align', 'center')
                            .append(editButton).append(' ').append(deleteButton);
                        if (metadata.hasOwnProperty('key')) {
                            editButton.remove();
                            tableBody.find('.delBtn').remove();
                            buttonCell.append(deleteButton);
                        }
                        if (metadata.hasOwnProperty('expcalculate')) {
                            $("#finalSubmitBtn").prop("disabled", false);
                            $("#close-unit-modalBtn").html("Reset & close");
                        } else {
                            $("#finalSubmitBtn").prop("disabled", true);
                            $("#close-unit-modalBtn").html("Reset & close");
                        }
                        newRow.append(hiddenInput).append(buttonCell);
                        tableBody.append(newRow);
                        sno++;
                        $('#grandTotalInput').val(metadata.grandTotal !==
                            undefined && metadata.grandTotal !== null ? metadata
                            .grandTotal : 0);
                    });
                    if (tableBody.find('tr').length > 0) {
                        $('#mySelect').hide();
                        $('#metagrandtotal').show();
                    } else {
                        $('#mySelect').show();
                        $('#metagrandtotal').hide();
                    }
                    $('#successAlert').text('Previous Data Copied successfully');
                    $('#successAlert').addClass('alert-success').removeClass('alert-danger')
                        .show();
                    $("#close-unit-modalBtn").html("Reset & close");
                    // $("#finalSubmitBtn").prop("disabled", false);
                    setTimeout(function() {
                        $('#successAlert').hide();
                    }, 2000);
                    $('.rowCheckbox').prop('checked',
                        false);
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });

        function checkTableEmpty() {
            var tableBody = $("#dataTable1 tbody");
            if (tableBody.find('tr').length > 0) {
                $('#mySelect').hide();
                $('#metagrandtotal').show();
            } else {
                $('#mySelect').show();
                $('#metagrandtotal').hide();
            }
        }
        checkTableEmpty();
        $('.selectOption').click(function() {
            var selectedOption = $(this).data('value');
            $('#selectOptionButton').addClass('btn-clicked');
            if (selectedOption === "RULE") {} else if (selectedOption === "OTHER") {
                $('#additionalFields').hide();
                $('#myForm').show();
            }
        });
        $("#selectAllCheckbox").change(function() {
            if ($(this).is(":checked")) {
                $(".metatable input[type=checkbox]").prop("checked", true);
            } else {
                $(".metatable input[type=checkbox]").prop("checked", false);
            }
        });
        $("#selectAllCheckbox, .metatable input[type=checkbox]").change(function() {
            var anyChecked = false;
            $(".metatable input[type=checkbox]").each(function() {
                if ($(this).prop("checked")) {
                    anyChecked = true;
                    return false;
                }
            });
            var grandTotalValue = parseFloat($('#grandTotalInput').val());
            if (anyChecked && grandTotalValue === 0) {
                $('#totalOnSelected').prop('disabled', false);
            } else {
                $('#totalOnSelected').prop('disabled', true);
            }
        });
        $('#totalOnSelected').on('click', function() {
            var grandTotalValue = $('#grandTotalInput').val();
            if (parseFloat(grandTotalValue) !== 0) {
                alert("Total already done!");
                if (!this.acceptenceCriteria()) {
                    return;
                }
                $("#totalOnSelected").prop("disabled", true);
            } else {
                var form = document.getElementById("simpsonsRuleForm");
                form.reset();
                currentId = null;
                type = "";
                $('#additionalFields').hide();
                $('#myForm').hide();
                var anyChecked = false;
                $(".metatable input[type=checkbox]").each(function() {
                    if ($(this).prop('checked')) {
                        anyChecked = true;
                        return false;
                    }
                });
                if (!anyChecked) {
                    alert('Please select at least one row before clicking the button.');
                    return;
                }
                var expression = '';
                var totalOverallTotal = 0;
                $('.metatable tr').each(function() {
                    var serialNumber = $(this).find('td:eq(1)').text();
                    if ($(this).find('.rowCheckbox').prop(
                            'checked')) {
                        if (serialNumber) {
                            expression += serialNumber + '+';
                        }
                        var overallTotal = $(this).find('td:eq(3)').text();
                        overallTotal = parseFloat(overallTotal);
                        if (!isNaN(overallTotal)) {
                            totalOverallTotal += overallTotal;
                        }
                    }
                });
                var inputValues = {};
                expression = expression.slice(0, -1);
                inputValues["parent_id"] = '{!! $unit_id !!}';
                inputValues["currentId"] = currentId;
                inputValues["type"] = expression;
                inputValues["unit"] = "Cum";
                inputValues["overallTotal"] = totalOverallTotal !== '' ? totalOverallTotal : 0;
                inputValues["grandTotal"] = totalOverallTotal !== '' ? totalOverallTotal : 0;
                inputValues["editEstimate_id"] = editEstimate_Id;
                inputValues["key"] = "total";
                inputValues["expcalculate"] = "Sumtotal";
                var ruledata = {
                    input_values: inputValues
                };
                $.ajax({
                    url: '/calculate-unit-modal-checkbox-expression-data',
                    type: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({
                        data: ruledata
                    }),
                    success: function(response) {
                        var tableBody1 = $("#dataTable tbody");
                        tableBody1.empty();
                        var rateAnalysisArray1 = response.rateAnalysisArray[unitId][
                            'metadata'
                        ];
                        if ($.isEmptyObject(rateAnalysisArray1)) {
                            $("#close-unit-modalBtn").html("Close");
                        }
                        var tableBody = $("#dataTable1 tbody");
                        tableBody.empty();

                        var sno = 0;
                        $.each(rateAnalysisArray1, function(index, metadata) {
                            var newRow = $("<tr>");
                            newRow.append(
                                '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                            );
                            newRow.append('<td style="text-align:center;">A' + (
                                    sno +
                                    1) +
                                '</td>');
                            newRow.append('<td style="text-align:center;">' +
                                metadata.type + (metadata.remarks ? ' (' +
                                    metadata.remarks + ')' : '') +
                                '</td>');
                            newRow.append('<td style="text-align:center;">' +
                                metadata
                                .overallTotal + '</td>');
                            newRow.append('<td style="text-align:center;">' +
                                metadata
                                .unit +
                                '</td>');
                            var editButtonClass = '';
                            if (metadata.btntype === 1) {
                                editButtonClass = 'editBtnrule';
                            } else if (metadata.btntype === 2) {
                                editButtonClass = 'editBtn';
                            } else if (metadata.btntype === 3) {
                                editButtonClass = 'defaultbtn';
                            } else if (metadata.btntype === 4) {
                                editButtonClass = 'sabtn';
                            } else if (metadata.btntype === 5) {
                                editButtonClass = 'apcbtn';
                            } else if (metadata.btntype === 6) {
                                editButtonClass = 'vcbtn';
                            }
                            var editButton = $('<a>').attr({
                                'type': 'button',
                                'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                    editButtonClass,
                                'data-id': metadata.currentId
                            }).text('edit');
                            var deleteButton = $('<a>').attr({
                                'type': 'button',
                                'class': 'btn btn-soft-danger btn-sm delBtn',
                                'data-id': metadata.currentId
                            }).text('Delete');
                            var grandTotalValue = metadata.grandTotal;
                            var hiddenInput = $('<input>').attr({
                                'type': 'hidden',
                                'id': 'metagrandval',
                                'value': grandTotalValue
                            });
                            var buttonCell = $('<td>').css('text-align', 'center')
                                .append(editButton).append(' ').append(
                                    deleteButton);
                            if (metadata.hasOwnProperty('key')) {
                                editButton.remove();
                                tableBody.find('.delBtn').remove();
                                buttonCell.append(deleteButton);
                            }
                            if (metadata.hasOwnProperty('expcalculate')) {
                                $("#finalSubmitBtn").prop("disabled", false);
                                $("#close-unit-modalBtn").html("Reset & close");
                            } else {
                                $("#finalSubmitBtn").prop("disabled", true);
                                $("#close-unit-modalBtn").html("Reset & close");
                            }
                            newRow.append(hiddenInput).append(buttonCell);
                            tableBody.append(newRow);
                            sno++;
                            //$('#grandTotalInput').val(metadata.overallTotal);
                        });

                        if (tableBody.find('tr').length > 0) {
                            $('#mySelect').hide();
                            $('#metagrandtotal').show();
                        } else {
                            $('#mySelect').show();
                            $('#metagrandtotal').hide();
                        }
                        $('#successAlert').text('Row Total added successfully');
                        $('#successAlert').addClass('alert-success').removeClass(
                                'alert-danger')
                            .show();
                        // $("#finalSubmitBtn").prop("disabled", false);
                        setTimeout(function() {
                            $('#successAlert').hide();
                        }, 2000);
                        $('#metagrandtotal').show();
                        $("#calexp").prop("disabled", true);
                        $("#close-unit-modalBtn").html("Reset & close");
                        //$("#finalSubmitBtn").prop("disabled", false);
                        $("#totalOnSelected").prop("disabled", true);
                        $('.rowCheckbox').prop('checked', false);
                        $('#Area-perimeter-circle').trigger('reset');
                        $('#Area-perimeter-circle').hide();
                        $('#surfaceArea-volume-rectangle').hide();
                        $('#Area-perimeter-rectangle').hide();
                        $('#additionalFields').hide();
                        $('#myForm').hide();
                        $('#surfaceArea-volume-rectangle').trigger('reset');
                        currentId = null;
                        $('.optionDropdown button.dropdown-toggle').prop('disabled', true);
                    },
                    error: function(xhr, status, error) {
                        var errorMessage = "An error occurred while calculating: ";
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage += xhr.responseJSON.error;
                        } else {
                            errorMessage += xhr.statusText;
                        }
                        alert(errorMessage);
                        console.error('Error occurred:', xhr.responseText);
                    }
                });
            }
        });
        $(".operationcalculate").click(function() {
            var grandTotalValue = $('#grandTotalInput').val();
            $('.rowCheckbox').prop('checked', false);
            if (parseFloat(grandTotalValue) !== 0) {
                if (!this.acceptenceCriteria()) {
                    return;
                }
                $("#totalOnSelected").prop("disabled", true);
            } else {
                var expression = $("#expression").val();
                // alert(expression);
                var exp = $("#expression").val();
                var remarks = $("#remarks").val();
                var editEstimate_Id = @json($editEstimate_id);
                var unitId = @json($unit_id);
                var alphaNumericRegex = /[A-Za-z0-9]/;
                if (expression.trim() === "") {
                    alert("Please enter a valid expression.");
                    return;
                }
                if (alphaNumericRegex.test(expression)) {
                    var rowIdentifierRegex = /[A-Za-z]\d+/g;
                    var rowIdentifiers = expression.match(rowIdentifierRegex);
                    if (rowIdentifiers) {
                        var invalidRowIds = [];
                        rowIdentifiers.forEach(function(rowId) {
                            var rowIndex = parseInt(rowId.substring(1)) - 1;
                            var row = $("#dataTable1 tbody tr:eq(" + rowIndex + ")");
                            if (row.length === 0) {
                                invalidRowIds.push(rowId);
                            } else {
                                var value = parseFloat(row.find("td:eq(3)").text().trim());
                                expression = expression.replace(rowId, value);
                            }
                        });
                        if (invalidRowIds.length > 0) {
                            alert("The following row(s) are not present in the table: " + invalidRowIds
                                .join(", "));
                            return;
                        }
                    }
                }
                var inputValues = {};
                inputValues["parent_id"] = '{!! $unit_id !!}';
                inputValues["currentId"] = currentId;
                inputValues["type"] = exp;
                inputValues["unit"] = "Cum";
                inputValues["overallTotal"] = expression;
                inputValues["exp"] = "exp";
                inputValues["editEstimate_id"] = editEstimate_Id;
                inputValues["key"] = "total";
                inputValues["remarks"] = remarks;
                var ruledata = {
                    input_values: inputValues
                };
                $.ajax({
                    url: '/calculate-unit-modal-expression-data',
                    type: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({
                        data: ruledata
                    }),
                    success: function(response) {
                        $("#expression").val("");
                        $("#remarks").val("");
                        $('.rowCheckbox').prop('checked', false);
                        var tableBody1 = $("#dataTable tbody");
                        tableBody1.empty();
                        var rateAnalysisArray2 = response.rateAnalysisArray[unitId][
                            'metadata'
                        ];
                        if ($.isEmptyObject(rateAnalysisArray2)) {
                            $("#close-unit-modalBtn").html("Close");
                        }
                        var tableBody = $("#dataTable1 tbody");
                        tableBody.empty();
                        var sno = 0;
                        $.each(rateAnalysisArray2, function(index, metadata) {
                            var newRow = $("<tr>");
                            newRow.append(
                                '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                            );
                            newRow.append('<td style="text-align:center;">A' + (
                                    sno +
                                    1) +
                                '</td>');
                            newRow.append('<td style="text-align:center;">' +
                                metadata.type + (metadata.remarks ? ' (' +
                                    metadata.remarks + ')' : '') +
                                '</td>');
                            newRow.append('<td style="text-align:center;">' +
                                metadata
                                .overallTotal + '</td>');
                            newRow.append('<td style="text-align:center;">' +
                                metadata
                                .unit +
                                '</td>');
                            var editButtonClass = '';
                            if (metadata.btntype === 1) {
                                editButtonClass = 'editBtnrule';
                            } else if (metadata.btntype === 2) {
                                editButtonClass = 'editBtn';
                            } else if (metadata.btntype === 3) {
                                editButtonClass = 'defaultbtn';
                            } else if (metadata.btntype === 4) {
                                editButtonClass = 'sabtn';
                            } else if (metadata.btntype === 5) {
                                editButtonClass = 'apcbtn';
                            } else if (metadata.btntype === 6) {
                                editButtonClass = 'vcbtn';
                            }
                            var editButton = $('<a>').attr({
                                'type': 'button',
                                'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                    editButtonClass,
                                'data-id': metadata.currentId
                            }).text('edit');
                            var deleteButton = $('<a>').attr({
                                'type': 'button',
                                'class': 'btn btn-soft-danger btn-sm delBtn',
                                'data-id': metadata.currentId
                            }).text('Delete');
                            var grandTotalValue = metadata.grandTotal;
                            var hiddenInput = $('<input>').attr({
                                'type': 'hidden',
                                'id': 'metagrandval',
                                'value': grandTotalValue
                            });
                            var buttonCell = $('<td>').css('text-align', 'center')
                                .append(editButton).append(' ').append(
                                    deleteButton);
                            if (metadata.hasOwnProperty('key')) {
                                editButton.remove();
                                tableBody.find('.delBtn').remove();
                                buttonCell.append(deleteButton);
                            }
                            if (metadata.hasOwnProperty('expcalculate')) {
                                $("#finalSubmitBtn").prop("disabled", false);
                                $("#close-unit-modalBtn").html("Reset & close");
                            } else {
                                $("#finalSubmitBtn").prop("disabled", true);
                                $("#close-unit-modalBtn").html("Reset & close");
                            }
                            newRow.append(hiddenInput).append(buttonCell);
                            tableBody.append(newRow);
                            sno++;
                            $('#grandTotalInput').val(metadata.grandTotal !==
                                undefined && metadata.grandTotal !== null ?
                                metadata.grandTotal : 0);
                        });
                        addNewRow();
                        updateTotalSum();
                        if (tableBody.find('tr').length > 0) {
                            $('#mySelect').hide();
                            $('#metagrandtotal').show();
                        } else {
                            $('#mySelect').show();
                            $('#metagrandtotal').hide();
                        }
                        $('#successAlert').text('Row  added successfully');
                        $('#successAlert').addClass('alert-success').removeClass(
                                'alert-danger')
                            .show();
                        // $("#finalSubmitBtn").prop("disabled", false);
                        setTimeout(function() {
                            $('#successAlert').hide();
                        }, 2000);
                        $('#metagrandtotal').show();
                        $("#calexp").prop("disabled", false);
                        $("#close-unit-modalBtn").html("Reset & close");
                        // $("#finalSubmitBtn").prop("disabled", false);
                        $("#totalOnSelected").prop("disabled", true);
                        $('.rowCheckbox').prop('checked', false);
                        $('#additionalFields').hide();
                        $('#myForm').hide();

                    },
                    error: function(xhr, status, error) {
                        var errorMessage = "An error occurred while calculating: ";
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage += xhr.responseJSON.error;
                        } else {
                            errorMessage += xhr.statusText;
                        }
                        alert(errorMessage);
                        console.error('Error occurred:', xhr.responseText);
                    }
                });
            }
        });

        $('#surfaceArea-volume-rectangle').submit(function(event) {
            event.preventDefault();
            var length = $('#salength').val();
            var width = $('#sawidth').val();
            var height = $('#saheight').val();
            var currentId = $('#btn-type1').val();
            if (!length || !width || !height) {
                if (!length) $('#salength').addClass('highlight');
                else $('.salength').removeClass('highlight');
                if (!width) $('#sawidth').addClass('highlight');
                else $('.sawidth').removeClass('highlight');
                if (!height) $('#saheight').addClass('highlight');
                else $('.saheight').removeClass('highlight');
            } else {
                $('.salength').removeClass('highlight');
                $('.sawidth').removeClass('highlight');
                $('.saheight').removeClass('highlight');
            }
            if (isNaN(length) || isNaN(width) || isNaN(height) || length <= 0 || width <= 0 || height <=
                0) {
                alert('Please enter valid values for length,width and height.');
                return;
            }
            // currentId = this.getAttribute("data-id")
            var surfaceArea = 2 * (length * width + length * height + width * height);
            var inputValues = {};
            inputValues["parent_id"] = unitId;
            inputValues["currentId"] = currentId;
            inputValues["type"] = "Surface Area of Rectangle";
            inputValues["btntype"] = 4;
            inputValues["unit"] = "Cum";
            inputValues["overallTotal"] = surfaceArea !== '' ? surfaceArea : 0;
            inputValues["length"] = length;
            inputValues["width"] = width;
            inputValues["height"] = height;
            inputValues["editEstimate_id"] = editEstimate_Id;
            var ruledata = {
                input_values: inputValues
            };
            console.log(ruledata);
            $.ajax({
                url: '/calculate-rule-surface-area',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    data: ruledata
                }),
                success: function(response) {
                    var tableBody1 = $("#dataTable tbody");
                    tableBody1.empty();
                    var rateAnalysisArray1 = response.rateAnalysisArray[
                        unitId][
                        'metadata'
                    ];
                    if ($.isEmptyObject(rateAnalysisArray1)) {
                        $("#close-unit-modalBtn").html("Close");
                    }
                    var tableBody = $("#dataTable1 tbody");
                    tableBody.empty();
                    var sno = 0;
                    $.each(rateAnalysisArray1, function(index, metadata) {
                        var newRow = $("<tr>");
                        newRow.append(
                            '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                        );
                        newRow.append(
                            '<td style="text-align:center;">A' +
                            (
                                sno +
                                1) +
                            '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata.type + (metadata.remarks ?
                                ' (' +
                                metadata.remarks + ')' : '') +
                            '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata
                            .overallTotal + '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata
                            .unit +
                            '</td>');
                        var editButtonClass = '';
                        if (metadata.btntype === 1) {
                            editButtonClass = 'editBtnrule';
                        } else if (metadata.btntype === 2) {
                            editButtonClass = 'editBtn';
                        } else if (metadata.btntype === 3) {
                            editButtonClass = 'defaultbtn';
                        } else if (metadata.btntype === 4) {
                            editButtonClass = 'sabtn';
                        } else if (metadata.btntype === 5) {
                            editButtonClass = 'apcbtn';
                        } else if (metadata.btntype === 6) {
                            editButtonClass = 'vcbtn';
                        }
                        var editButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                editButtonClass,
                            'data-id': metadata.currentId
                        }).text('edit');
                        var deleteButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-danger btn-sm delBtn',
                            'data-id': metadata.currentId
                        }).text('Delete');
                        var grandTotalValue = metadata.grandTotal;
                        var hiddenInput = $('<input>').attr({
                            'type': 'hidden',
                            'id': 'metagrandval',
                            'value': grandTotalValue
                        });
                        var buttonCell = $('<td>').css('text-align', 'center')
                            .append(editButton).append(' ').append(deleteButton);
                        if (metadata.hasOwnProperty('key')) {
                            editButton.remove();
                            tableBody.find('.delBtn').remove();
                            buttonCell.append(deleteButton);
                        }
                        if (metadata.hasOwnProperty('expcalculate')) {
                            $("#finalSubmitBtn").prop("disabled", false);
                            $("#close-unit-modalBtn").html("Reset & close");
                        } else {
                            $("#finalSubmitBtn").prop("disabled", true);
                            $("#close-unit-modalBtn").html("Reset & close");
                        }
                        newRow.append(hiddenInput).append(buttonCell);
                        tableBody.append(newRow);
                        sno++;
                        $('#grandTotalInput').val(metadata.grandTotal !==
                            undefined && metadata.grandTotal !== null ?
                            metadata.grandTotal : 0);
                    });
                    addNewRow();
                    updateTotalSum();
                    if (tableBody.find('tr').length > 0) {
                        $('#mySelect').hide();
                        $('#metagrandtotal').show();
                    } else {
                        $('#mySelect').show();
                        $('#metagrandtotal').hide();
                    }
                    $('.optionDropdown button.dropdown-toggle').prop('disabled', false);
                    $('#successAlert').text('Row added successfully');
                    $('#successAlert').addClass('alert-success')
                        .removeClass(
                            'alert-danger')
                        .show();
                    // $("#finalSubmitBtn").prop("disabled", false);
                    setTimeout(function() {
                        $('#successAlert').hide();
                    }, 2000);
                    $("#calexp").prop("disabled", false);
                    $('#metagrandtotal').show();
                    $("#close-unit-modalBtn").html("Reset & close");
                    // $("#finalSubmitBtn").prop("disabled", false);
                    $('.rowCheckbox').prop('checked', false);
                    $('#additionalFields').hide();
                    $('#myForm').hide();
                    $('#salength').val('');
                    $('#sawidth').val('');
                    $('#saheight').val('');
                    $('#surfaceArea-volume-rectangle').hide();
                    $('#Area-perimeter-circle').hide();
                    $('#Area-perimeter-rectangle').hide();
                    $('#additionalFields').hide();
                    $('#myForm').hide();
                    $('#surfaceArea-volume-rectangle').trigger('reset');
                    currentId = null;
                },
                error: function(xhr, status, error) {
                    var errorMessage =
                        "An error occurred while calculating: ";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += xhr.responseJSON.error;
                    } else {
                        errorMessage += xhr.statusText;
                    }
                    alert(errorMessage);
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        $('#Volume-of-cylinder').submit(function(event) {
            //alert("clicked");
            event.preventDefault();
            var diameter = $('#diameter').val();
            var height = $('#dia-height').val();
            var currentId = $('#btn-type2').val();
            if (!diameter || !width || !height) {
                if (!diameter) $('#diameter').addClass('highlight');
                else $('.diameter').removeClass('highlight');
                if (!height) $('#dia-height').addClass('highlight');
                else $('.dia-height').removeClass('highlight');
            } else {
                $('.diameter').removeClass('highlight');
                $('.dia-height').removeClass('highlight');
            }
            if (isNaN(diameter) || isNaN(height) || diameter <= 0 || height <=
                0) {
                alert('Please enter valid values for length,width and height.');
                return;
            }




            // currentId = this.getAttribute("data-id")
            var volume_of_cylinder = parseFloat((Math.PI * Math.pow(diameter, 2) * height / 4).toFixed(
                2));
            var inputValues = {};
            inputValues["parent_id"] = unitId;
            inputValues["currentId"] = currentId;
            inputValues["type"] = "Volume of Cylinder";
            inputValues["btntype"] = 6;
            inputValues["unit"] = "Cum";
            inputValues["overallTotal"] = volume_of_cylinder !== '' ? volume_of_cylinder : 0;
            inputValues["diameter"] = diameter;
            inputValues["height"] = height;
            inputValues["editEstimate_id"] = editEstimate_Id;
            var ruledata = {
                input_values: inputValues
            };
            console.log(ruledata);
            $.ajax({
                url: '/calculate-rule-surface-area',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    data: ruledata
                }),
                success: function(response) {
                    var tableBody1 = $("#dataTable tbody");
                    tableBody1.empty();
                    var rateAnalysisArray1 = response.rateAnalysisArray[
                        unitId][
                        'metadata'
                    ];
                    if ($.isEmptyObject(rateAnalysisArray1)) {
                        $("#close-unit-modalBtn").html("Close");
                    }
                    var tableBody = $("#dataTable1 tbody");
                    tableBody.empty();
                    var sno = 0;
                    $.each(rateAnalysisArray1, function(index, metadata) {
                        var newRow = $("<tr>");
                        newRow.append(
                            '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                        );
                        newRow.append(
                            '<td style="text-align:center;">A' +
                            (
                                sno +
                                1) +
                            '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata.type + (metadata.remarks ?
                                ' (' +
                                metadata.remarks + ')' : '') +
                            '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata
                            .overallTotal + '</td>');
                        newRow.append(
                            '<td style="text-align:center;">' +
                            metadata
                            .unit +
                            '</td>');
                        var editButtonClass = '';
                        if (metadata.btntype === 1) {
                            editButtonClass = 'editBtnrule';
                        } else if (metadata.btntype === 2) {
                            editButtonClass = 'editBtn';
                        } else if (metadata.btntype === 3) {
                            editButtonClass = 'defaultbtn';
                        } else if (metadata.btntype === 4) {
                            editButtonClass = 'sabtn';
                        } else if (metadata.btntype === 5) {
                            editButtonClass = 'apcbtn';
                        } else if (metadata.btntype === 6) {
                            editButtonClass = 'vcbtn';
                        }
                        var editButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                editButtonClass,
                            'data-id': metadata.currentId
                        }).text('edit');
                        var deleteButton = $('<a>').attr({
                            'type': 'button',
                            'class': 'btn btn-soft-danger btn-sm delBtn',
                            'data-id': metadata.currentId
                        }).text('Delete');
                        var grandTotalValue = metadata.grandTotal;
                        var hiddenInput = $('<input>').attr({
                            'type': 'hidden',
                            'id': 'metagrandval',
                            'value': grandTotalValue
                        });
                        var buttonCell = $('<td>').css('text-align', 'center')
                            .append(editButton).append(' ').append(deleteButton);
                        if (metadata.hasOwnProperty('key')) {
                            editButton.remove();
                            tableBody.find('.delBtn').remove();
                            buttonCell.append(deleteButton);
                        }
                        if (metadata.hasOwnProperty('expcalculate')) {
                            $("#finalSubmitBtn").prop("disabled", false);
                            $("#close-unit-modalBtn").html("Reset & close");
                        } else {
                            $("#finalSubmitBtn").prop("disabled", true);
                            $("#close-unit-modalBtn").html("Reset & close");
                        }
                        newRow.append(hiddenInput).append(buttonCell);
                        tableBody.append(newRow);
                        sno++;
                        $('#grandTotalInput').val(metadata.grandTotal !==
                            undefined && metadata.grandTotal !== null ?
                            metadata.grandTotal : 0);
                    });
                    addNewRow();
                    updateTotalSum();
                    if (tableBody.find('tr').length > 0) {
                        $('#mySelect').hide();
                        $('#metagrandtotal').show();
                    } else {
                        $('#mySelect').show();
                        $('#metagrandtotal').hide();
                    }
                    $('.optionDropdown button.dropdown-toggle').prop('disabled', false);
                    $('#successAlert').text('Row added successfully');
                    $('#successAlert').addClass('alert-success')
                        .removeClass(
                            'alert-danger')
                        .show();
                    // $("#finalSubmitBtn").prop("disabled", false);
                    setTimeout(function() {
                        $('#successAlert').hide();
                    }, 2000);
                    $("#calexp").prop("disabled", false);
                    $('#metagrandtotal').show();
                    $("#close-unit-modalBtn").html("Reset & close");
                    // $("#finalSubmitBtn").prop("disabled", false);
                    $('.rowCheckbox').prop('checked', false);
                    $('#additionalFields').hide();
                    $('#myForm').hide();
                    $('#salength').val('');
                    $('#sawidth').val('');
                    $('#saheight').val('');
                    $('#surfaceArea-volume-rectangle').hide();
                    $('#Area-perimeter-circle').hide();
                    $('#Volume-of-cylinder').hide();
                    $('#Volume-of-cylinder').trigger('reset');
                    $('#Area-perimeter-rectangle').hide();
                    $('#additionalFields').hide();
                    $('#myForm').hide();
                    $('#surfaceArea-volume-rectangle').trigger('reset');
                    currentId = null;
                },
                error: function(xhr, status, error) {
                    var errorMessage =
                        "An error occurred while calculating: ";
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage += xhr.responseJSON.error;
                    } else {
                        errorMessage += xhr.statusText;
                    }
                    alert(errorMessage);
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        $(document).on("click", ".vcbtn", function() {
            currentId = this.getAttribute("data-id");
            $('#Volume-of-cylinder').show();
            $('#surfaceArea-volume-rectangle').hide();
            $('#Area-perimeter-rectangle').hide();
            $('#additionalFields').hide();
            $('#myForm').hide();
            $('#Area-perimeter-circle').hide();
            $.ajax({
                url: '/get-modal-rule-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    unitId: unitId,
                    ruleId: currentId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    console.log(response.rateAnalysisArray.input_values);
                    $('#diameter').val(response.rateAnalysisArray.input_values.diameter);
                    $('#dia-height').val(response.rateAnalysisArray.input_values.height);
                    $('#btn-type2').val(response.rateAnalysisArray.input_values.currentId);
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        $(document).on("click", ".sabtn", function() {
            currentId = this.getAttribute("data-id");
            $('#surfaceArea-volume-rectangle').show();
            $('#Area-perimeter-rectangle').hide();
            $('#additionalFields').hide();
            $('#myForm').hide();
            $('#Area-perimeter-circle').hide();
            $.ajax({
                url: '/get-modal-rule-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    unitId: unitId,
                    ruleId: currentId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    console.log(response.rateAnalysisArray.input_values);
                    $('#salength').val(response.rateAnalysisArray.input_values.length);
                    $('#sawidth').val(response.rateAnalysisArray.input_values.width);
                    $('#saheight').val(response.rateAnalysisArray.input_values.height);
                    $('#btn-type1').val(response.rateAnalysisArray.input_values.currentId);
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        $(document).on("click", ".defaultbtn", function() {
            currentId = this.getAttribute("data-id");
            $('#Area-perimeter-rectangle').show();
            $('#additionalFields').hide();
            $('#myForm').hide();
            $('#Area-perimeter-circle').hide();
            $('#surfaceArea-volume-rectangle').hide();
            $.ajax({
                url: '/get-modal-rule-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    unitId: unitId,
                    ruleId: currentId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    console.log(response.rateAnalysisArray.input_values);
                    $('#length').val(response.rateAnalysisArray.input_values.length);
                    $('#width').val(response.rateAnalysisArray.input_values.width);
                    var type = response.rateAnalysisArray.input_values.type;
                    var textInBracket = type.match(/\(([^)]+)\)/)[1];
                    if (textInBracket === 'area') {
                        $('#areaValue').text(response.rateAnalysisArray.input_values
                            .overallTotal);
                        $('#perimeterValue').text('');
                        $('input[name="calcOption"]').removeAttr(
                            'checked');
                        $('input[name="calcOption"][value="' + textInBracket + '"]').prop(
                            'checked', true);
                    } else if (textInBracket === 'perimeter') {
                        $('#perimeterValue').text(response.rateAnalysisArray.input_values
                            .overallTotal);
                        $('#areaValue').text('');
                        $('input[name="calcOption"]').removeAttr(
                            'checked');
                        $('input[name="calcOption"][value="' + textInBracket + '"]').prop(
                            'checked', true);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        $('.selectOptionn').click(function() {
            var selectedShape = $(this).attr('data-value');
            $('.circle-dropdown').text($(this).text());
            var pi = "π";
            if (selectedShape === 'circle') {
                $('.formula').html(
                    `Formula: Area of Circle = ${pi}R<sup>2</sup> / Perimeter = 2${pi}R`);
                $('.perimeterRadiocircle').show();
                $('.areaRadiocircle').show();
            } else if (selectedShape === 'semiCircle') {
                $('.formula').html(
                    `Formula: Area of Semi-circle = ${pi}R<sup>2</sup>/2 + R<sup>2</sup> / Perimeter = ${pi}R + 2R`
                );
                $('.perimeterRadiocircle').show();
                $('.areaRadiocircle').show();
            } else if (selectedShape === 'quarterCircle') {
                $('.formula').html(
                    `Formula: Area of Quarter Circle = ${pi}R<sup>2</sup>/4 + R<sup>2</sup> / Perimeter = ${pi}R/2 + 2R`
                );
                $('.perimeterRadiocircle').show();
                $('.areaRadiocircle').show();
            } else if (selectedShape === 'Surface Area of Sphere') {
                $('.formula').html(`Formula: Surface Area of Sphere = 4${pi}R<sup>2</sup>`);
                $('input[name="calcOptionn"]').prop('checked', false)
                $('.perimeterRadiocircle').hide();
                $('.areaRadiocircle').show();
            } else if (selectedShape === 'Volume of Sphere') {
                $('.formula').html(`Formula: Volume of Sphere = ${pi}R<sup>3</sup>`);
                $('input[name="calcOptionn"]').prop('checked', false)
                $('.perimeterRadiocircle').hide();
                $('.areaRadiocircle').hide();
            } else if (selectedShape === 'Surface Area of Hemisphere') {
                $('.formula').html(
                    `Formula: Surface Area of Hemisphere = 2${pi}R<sup>2</sup> + ${pi}R<sup>2</sup>`
                );
                $('input[name="calcOptionn"]').prop('checked', false);
                $('.perimeterRadiocircle').hide();
                $('.areaRadiocircle').hide();
            } else if (selectedShape === 'Volume of Hemisphere') {
                $('.formula').html(`Formula: Volume of Hemisphere = 2/3${pi}R<sup>3</sup>`);
                $('input[name="calcOptionn"]').prop('checked', false)
                $('.perimeterRadiocircle').hide();
                $('.areaRadiocircle').hide();
            } else {
                $('.formula').html('');
            }
        });
        $('.dropdown-menu .selectOptionn').on('click', function() {
            $('.dropdown-menu .selectOptionn').removeClass('active');
            $(this).addClass('active');
        });
        $('#saveBtnn').on('click', function() {
            var totalOverallTotal = 0;
            currentId = parseFloat($('#btntype').val());
            var selectedcircleShape = $('.dropdown-menu').find('a.selectOptionn.active').attr(
                'data-value');
            var type = 'Area and perimeter of ' + selectedcircleShape;
            var radius = parseFloat($('#radius').val());
            var dataValue = parseFloat($('#btntype').val());
            var calculationType = $('input[name="calcOptionn"]:checked').val();
            var area, perimeter;
            if (!selectedcircleShape) {
                $('.circle-dropdown').addClass('highlight');
            } else {
                $('.circle-dropdown').removeClass('highlight');
            }
            if (!selectedcircleShape) {
                $('#dropdownMessage').show();
            } else {
                $('#dropdownMessage').hide();
            }
            if (!radius) {
                $('#radiusMessage').show();
            } else {
                $('#radiusMessage').hide();
            }
            if (!radius) {
                $('#radius').addClass('highlight');
            } else {
                $('#radius').removeClass('highlight');
            }
            if (!calculationType) {
                $('input[name="calcOptionn"]').addClass('highlight');
            } else {
                $('input[name="calcOptionn"]').removeClass('highlight');
            }
            if (selectedcircleShape === "Volume of Sphere" || selectedcircleShape ===
                "Volume of Hemisphere") {
                calculationType = "volume";
            }
            if (selectedcircleShape === 'Surface Area of Hemisphere') {
                calculationType = "Area";
            }
            if (selectedcircleShape && calculationType && radius) {
                if (selectedcircleShape === 'circle') {
                    area = Math.PI * Math.pow(radius, 2);
                    perimeter = 2 * Math.PI * radius;
                } else if (selectedcircleShape === 'semiCircle') {
                    area = 0.5 * Math.PI * Math.pow(radius, 2);
                    perimeter = Math.PI * radius + 2 * radius;
                } else if (selectedcircleShape === 'quarterCircle') {
                    area = 0.25 * Math.PI * Math.pow(radius, 2);
                    perimeter = 0.5 * Math.PI * radius + 2 * radius;
                } else if (selectedcircleShape === 'Surface Area of Sphere') {
                    area = 4 * Math.PI * Math.pow(radius, 2);
                    type = selectedcircleShape;
                } else if (selectedcircleShape === 'Volume of Sphere') {
                    area = (4 / 3) * Math.PI * Math.pow(radius, 3);
                    type = selectedcircleShape;
                } else if (selectedcircleShape === 'Surface Area of Hemisphere') {
                    var curvedSurfaceArea = 2 * Math.PI * Math.pow(radius, 2);
                    var circularBaseArea = Math.PI * Math.pow(radius, 2);
                    area = curvedSurfaceArea + circularBaseArea;
                    type = selectedcircleShape;
                } else if (selectedcircleShape === 'Volume of Hemisphere') {
                    area = (2 / 3) * Math.PI * Math.pow(radius, 3);
                    type = selectedcircleShape;
                }
                if (calculationType === 'area') {
                    totalOverallTotal = parseFloat(area.toFixed(2));
                } else if (calculationType === 'perimeter') {
                    totalOverallTotal = parseFloat(perimeter.toFixed(2));
                } else {
                    totalOverallTotal = parseFloat(area.toFixed(2));
                }
                var inputValues = {};
                inputValues["parent_id"] = unitId;
                inputValues["currentId"] = currentId;
                inputValues["type"] = type + '(' + calculationType + ')';
                inputValues["selectedcircleShape"] = selectedcircleShape;
                inputValues["calculationType"] = calculationType;
                inputValues["btntype"] = 5;
                inputValues["unit"] = "Cum";
                inputValues["overallTotal"] = totalOverallTotal !== '' ? totalOverallTotal : 0;
                inputValues["radius"] = radius;
                inputValues["editEstimate_id"] = editEstimate_Id;
                var ruledata = {
                    input_values: inputValues
                };
                $.ajax({
                    url: '/calculate-rule-area-perimeter-circle',
                    type: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    contentType: 'application/json',
                    data: JSON.stringify({
                        data: ruledata
                    }),
                    success: function(response) {
                        var tableBody1 = $("#dataTable tbody");
                        tableBody1.empty();
                        var rateAnalysisArray1 = response.rateAnalysisArray[
                            unitId]['metadata'];
                        if ($.isEmptyObject(rateAnalysisArray1)) {
                            $("#close-unit-modalBtn").html("Close");
                        }
                        var tableBody = $("#dataTable1 tbody");
                        tableBody.empty();
                        var sno = 0;
                        $.each(rateAnalysisArray1, function(index, metadata) {
                            var newRow = $("<tr>");
                            newRow.append(
                                '<td style="text-align:center;"><input type="checkbox"class="rowCheckbox form-checkbox rounded transition ease-in-out duration-100 border-secondary-300 text-primary-600 focus:ring-primary-600 focus:border-primary-400 dark:border-secondary-500 dark:checked:border-secondary-600 dark:focus:ring-secondary-600 dark:focus:border-secondary-500 dark:bg-secondary-600 dark:text-secondary-600 dark:focus:ring-offset-secondary-800" /></td>'
                            );
                            newRow.append(
                                '<td style="text-align:center;">A' +
                                (
                                    sno +
                                    1) +
                                '</td>');
                            newRow.append(
                                '<td style="text-align:center;">' +
                                metadata.type + (metadata.remarks ?
                                    ' (' +
                                    metadata.remarks + ')' : '') +
                                '</td>');
                            newRow.append(
                                '<td style="text-align:center;">' +
                                metadata
                                .overallTotal + '</td>');
                            newRow.append(
                                '<td style="text-align:center;">' +
                                metadata
                                .unit +
                                '</td>');
                            var editButtonClass = '';
                            if (metadata.btntype === 1) {
                                editButtonClass = 'editBtnrule';
                            } else if (metadata.btntype === 2) {
                                editButtonClass = 'editBtn';
                            } else if (metadata.btntype === 3) {
                                editButtonClass = 'defaultbtn';
                            } else if (metadata.btntype === 4) {
                                editButtonClass = 'sabtn';
                            } else if (metadata.btntype === 5) {
                                editButtonClass = 'apcbtn';
                            } else if (metadata.btntype === 6) {
                                editButtonClass = 'vcbtn';
                            }
                            var editButton = $('<a>').attr({
                                'type': 'button',
                                'class': 'btn btn-soft-secondary btn-sm mr-2 fetchdetails ' +
                                    editButtonClass,
                                'data-id': metadata.currentId
                            }).text('edit');
                            var deleteButton = $('<a>').attr({
                                'type': 'button',
                                'class': 'btn btn-soft-danger btn-sm delBtn',
                                'data-id': metadata.currentId
                            }).text('Delete');
                            var grandTotalValue = metadata.grandTotal;
                            var hiddenInput = $('<input>').attr({
                                'type': 'hidden',
                                'id': 'metagrandval',
                                'value': grandTotalValue
                            });
                            var buttonCell = $('<td>').css('text-align', 'center')
                                .append(editButton).append(' ').append(
                                    deleteButton);
                            if (metadata.hasOwnProperty('key')) {
                                editButton.remove();
                                tableBody.find('.delBtn').remove();
                                buttonCell.append(deleteButton);
                            }
                            if (metadata.hasOwnProperty('expcalculate')) {
                                $("#finalSubmitBtn").prop("disabled", false);
                                $("#close-unit-modalBtn").html("Reset & close");
                            } else {
                                $("#finalSubmitBtn").prop("disabled", true);
                                $("#close-unit-modalBtn").html("Reset & close");
                            }
                            newRow.append(hiddenInput).append(buttonCell);
                            tableBody.append(newRow);
                            sno++;
                            $('#grandTotalInput').val(metadata.grandTotal !==
                                undefined && metadata.grandTotal !== null ?
                                metadata.grandTotal : 0);
                        });
                        addNewRow();
                        updateTotalSum();
                        if (tableBody.find('tr').length > 0) {
                            $('#mySelect').hide();
                            $('#metagrandtotal').show();
                        } else {
                            $('#mySelect').show();
                            $('#metagrandtotal').hide();
                        }
                        $('#successAlert').text('Row  added successfully');
                        $('#successAlert').addClass('alert-success')
                            .removeClass(
                                'alert-danger')
                            .show();
                        // $("#finalSubmitBtn").prop("disabled", false);
                        setTimeout(function() {
                            $('#successAlert').hide();
                        }, 2000);
                        $('#metagrandtotal').show();
                        $("#close-unit-modalBtn").html("Reset & close");
                        // $("#finalSubmitBtn").prop("disabled", false);
                        $('.rowCheckbox').prop('checked', false);
                        $('#additionalFields').hide();
                        $('#myForm').hide();
                        $("#calexp").prop("disabled", false);
                        var form = document.getElementById(
                            "area-perimeter-circle");
                        form.reset();
                        $('.dropdown-menu').find('.selected').removeClass('selected');
                        $('.dropdown-menu').find('.active').removeClass('active');
                        $('.dropdown-menu').find('.show').removeClass('show');
                        $('.dropdown-menu').find('.dropdown-toggle').attr('aria-expanded',
                            'false');
                        $('.circle-dropdown').text('Select Shape');
                        $('input[name="calcOptionn"]').prop('checked', false);
                        $('#btntype').val('');
                        $('.optionDropdown button.dropdown-toggle').prop('disabled', false);
                        $('#Area-perimeter-rectangle').hide();
                        $('#Area-perimeter-circle').hide();
                        $('#surfaceArea-volume-rectangle').hide();
                        $('#additionalFields').hide();
                        $('#myForm').hide();
                        var form = document.getElementById("area-perimeter-rectangle");
                        form.reset();
                        currentId = null;
                    },
                    error: function(xhr, status, error) {
                        var errorMessage =
                            "An error occurred while calculating: ";
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage += xhr.responseJSON.error;
                        } else {
                            errorMessage += xhr.statusText;
                        }
                        alert(errorMessage);
                        console.error('Error occurred:', xhr.responseText);
                    }
                });
            }
        });
        $(document).on("click", ".apcbtn", function() {
            currentId = this.getAttribute("data-id");
            $('#Area-perimeter-circle').show();
            $('#surfaceArea-volume-rectangle').hide();
            $('#Area-perimeter-rectangle').hide();
            $('#additionalFields').hide();
            $('#myForm').hide();
            $.ajax({
                url: '/get-modal-rule-data',
                type: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                contentType: 'application/json',
                data: JSON.stringify({
                    unitId: unitId,
                    ruleId: currentId,
                    editEstimate_id: editEstimate_Id
                }),
                success: function(response) {
                    var checkCalculationType = response.rateAnalysisArray.input_values
                        .calculationType;
                    if (checkCalculationType === 'area' || checkCalculationType ===
                        'perimeter') {
                        $('.perimeterRadiocircle').show();
                        $('.areaRadiocircle').show();
                    } else {
                        $('.perimeterRadiocircle').hide();
                        $('.areaRadiocircle').hide();
                    }
                    $('#btntype').val(response.rateAnalysisArray.input_values.currentId);
                    $('#radius').val(response.rateAnalysisArray.input_values.radius);
                    $('.dropdown-menu').find('a[data-value="' + response.rateAnalysisArray
                        .input_values.selectedcircleShape + '"]').addClass('active');
                    var selectedOptionText = $('.dropdown-menu').find('a[data-value="' +
                        response.rateAnalysisArray.input_values.selectedcircleShape +
                        '"]').text();
                    $('.circle-dropdown').html(selectedOptionText);
                    var calculationType = response.rateAnalysisArray
                        .input_values.calculationType;
                    $('input[name="calcOptionn"]').removeAttr(
                        'checked');
                    $('input[name="calcOptionn"][value="' + calculationType + '"]').prop(
                        'checked', true);
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', xhr.responseText);
                }
            });
        });
        addNewRow();
        updateTotalSum();
        $('input[name="calcOptionn"]').prop('checked', false);
        $(document).on("click", ".fetchdetails", function() {
            fetchRowDetails(this);
        });
    });

    function fetchRowDetails(btn) {
        $('.formula').html('');
        var row = btn.closest('tr');
        var cells = row.cells;
        var serialNumber = cells[1].innerText;
        var option = cells[2].innerText;
        $('.formula').html('<span>' + serialNumber + '</span><span>: ' + option + '</span>');
    }
</script>
